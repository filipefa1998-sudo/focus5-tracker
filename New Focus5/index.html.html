<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus 5 Missionary Tracker - Live Sync</title>
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK - Updated to version 9 compat -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        }
        .indicator-popup {
            position: fixed;
            background: white;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            min-width: 280px;
            max-height: 400px;
            overflow-y: auto;
        }
        .indicator-btn {
            transition: all 0.2s;
        }
        .indicator-btn:hover {
            transform: scale(1.05);
        }
        .kpi-card {
            transition: transform 0.2s;
        }
        .kpi-card:hover {
            transform: translateY(-2px);
        }
        .sync-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .sync-indicator.synced {
            background: #10b981;
            color: white;
        }
        .sync-indicator.syncing {
            background: #f59e0b;
            color: white;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse {
            animation: pulse 2s ease-in-out infinite;
        }
        @media print {
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAMTk39-yO86IA36-ZzBCtpLswW4skCIH4",
            authDomain: "focus5-cd663.firebaseapp.com",
            projectId: "focus5-cd663",
            storageBucket: "focus5-cd663.firebasestorage.app",
            messagingSenderId: "408021579800",
            appId: "1:408021579800:web:e064f6e4c13b7ac2d9eb6d",
            databaseURL: "https://focus5-cd663-default-rtdb.firebaseio.com"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();

        // Indicators for Current Investigators - Invitations Extended
        const INVESTIGATOR_INDICATORS = [
            { id: 'RB', label: 'Read Book of Mormon', color: 'bg-red-600' },
            { id: 'AC', label: 'Attend Church', color: 'bg-blue-600' },
            { id: 'AA', label: 'Attend Activity', color: 'bg-green-600' },
            { id: 'FHE', label: 'Attend FHE', color: 'bg-purple-600' },
            { id: 'TM', label: 'Taught by Missionaries', color: 'bg-indigo-600' },
            { id: 'PB', label: 'Pray about BOM', color: 'bg-pink-600' },
            { id: 'BD', label: 'Baptismal Date Set', color: 'bg-orange-600' },
            { id: 'BC', label: 'Baptism Completed', color: 'bg-yellow-500' },
        ];

        // Indicators for Less Active/Part Member Families - Fellowship Activities
        const FELLOWSHIP_INDICATORS = [
            { id: 'SRV', label: 'Service', color: 'bg-green-600' },
            { id: 'AI', label: 'Activity Invited', color: 'bg-blue-600' },
            { id: 'AAT', label: 'Activity Attended', color: 'bg-teal-600' },
            { id: 'VIS', label: 'Visit', color: 'bg-purple-600' },
            { id: 'IFH', label: 'Invited to do Family History', color: 'bg-indigo-600' },
            { id: 'TXT', label: 'Text/Call', color: 'bg-pink-600' },
        ];

        const MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

        const COVENANT_PATH_ITEMS = [
            'Make Friends with Members of Your Ward',
            'Improve Gospel Study',
            'Learn about the Aaronic Priesthood and the Young Men Program',
            'Learn about Young Women Program',
            'Learn about the Relief Society',
            'Learn about Primary‚ÄîServing Children',
            'Receive a Temple Recommend for Proxy Baptisms and Confirmations',
            'Help Ancestors Receive Sacred Ordinances',
            'Keep the Sabbath Day Holy',
            'Serve Others',
            'Share the Gospel',
            'Participate in a Home Evening',
            'Follow the Prophet',
            'Obey the Commandments',
            'Be Self-Reliant',
            'Overcome Discouragement and Setbacks',
            'Learn about the Melchizedek Priesthood',
            'Receive a Patriarchal Blessing',
            'Receive Your Endowment',
            'Be Sealed to Your Family'
        ];

        function Focus5Tracker() {
            const [investigators, setInvestigators] = useState([
                { id: 1, name: '', assignment: '', notes: '', months: {}, covenantPath: [] },
                { id: 2, name: '', assignment: '', notes: '', months: {}, covenantPath: [] },
                { id: 3, name: '', assignment: '', notes: '', months: {}, covenantPath: [] },
                { id: 4, name: '', assignment: '', notes: '', months: {}, covenantPath: [] },
                { id: 5, name: '', assignment: '', notes: '', months: {}, covenantPath: [] },
            ]);

            const [lessActives, setLessActives] = useState([
                { id: 6, name: '', assignment: '', notes: '', months: {} },
                { id: 7, name: '', assignment: '', notes: '', months: {} },
                { id: 8, name: '', assignment: '', notes: '', months: {} },
                { id: 9, name: '', assignment: '', notes: '', months: {} },
                { id: 10, name: '', assignment: '', notes: '', months: {} },
            ]);

            const [showPopup, setShowPopup] = useState(null);
            const [lastSaved, setLastSaved] = useState(null);
            const [kpiView, setKpiView] = useState('current');
            const [customStartDate, setCustomStartDate] = useState('');
            const [customEndDate, setCustomEndDate] = useState('');
            const [syncStatus, setSyncStatus] = useState('synced'); // 'synced' or 'syncing'
            const [isLoading, setIsLoading] = useState(true);
            
            const popupRef = useRef(null);
            const savingRef = useRef(false);

            // Load data from Firebase on mount
            useEffect(() => {
                const investigatorsRef = database.ref('investigators');
                const lessActivesRef = database.ref('lessActives');

                investigatorsRef.on('value', (snapshot) => {
                    if (snapshot.exists() && !savingRef.current) {
                        const data = snapshot.val();
                        const withCovenantPath = data.map(p => ({
                            ...p,
                            covenantPath: p.covenantPath || []
                        }));
                        setInvestigators(withCovenantPath);
                    }
                    setIsLoading(false);
                });

                lessActivesRef.on('value', (snapshot) => {
                    if (snapshot.exists() && !savingRef.current) {
                        setLessActives(snapshot.val());
                    }
                });

                return () => {
                    investigatorsRef.off();
                    lessActivesRef.off();
                };
            }, []);

            // Save to Firebase whenever data changes
            useEffect(() => {
                if (!isLoading) {
                    savingRef.current = true;
                    setSyncStatus('syncing');
                    
                    database.ref('investigators').set(investigators);
                    database.ref('lessActives').set(lessActives);
                    
                    const timer = setTimeout(() => {
                        setSyncStatus('synced');
                        setLastSaved(new Date());
                        savingRef.current = false;
                    }, 500);

                    return () => clearTimeout(timer);
                }
            }, [investigators, lessActives, isLoading]);

            // Close popup when clicking outside
            useEffect(() => {
                function handleClickOutside(event) {
                    if (popupRef.current && !popupRef.current.contains(event.target)) {
                        setShowPopup(null);
                    }
                }

                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            const updatePerson = (list, setList, id, field, value) => {
                setList(list.map(person => 
                    person.id === id ? { ...person, [field]: value } : person
                ));
            };

            const toggleIndicator = (list, setList, personId, month, indicatorId) => {
                setList(list.map(person => {
                    if (person.id === personId) {
                        const monthData = person.months[month] || [];
                        const hasIndicator = monthData.includes(indicatorId);
                        
                        return {
                            ...person,
                            months: {
                                ...person.months,
                                [month]: hasIndicator 
                                    ? monthData.filter(i => i !== indicatorId)
                                    : [...monthData, indicatorId]
                            }
                        };
                    }
                    return person;
                }));
            };

            const toggleCovenantPathItem = (personId, item) => {
                setInvestigators(investigators.map(person => {
                    if (person.id === personId) {
                        const covenantPath = person.covenantPath || [];
                        const hasItem = covenantPath.includes(item);
                        
                        return {
                            ...person,
                            covenantPath: hasItem 
                                ? covenantPath.filter(i => i !== item)
                                : [...covenantPath, item]
                        };
                    }
                    return person;
                }));
            };

            const hasBaptismCompleted = (person) => {
                return Object.values(person.months || {}).some(monthActivities => 
                    monthActivities.includes('BC')
                );
            };

            const exportData = () => {
                const data = {
                    investigators,
                    lessActives,
                    exportDate: new Date().toISOString()
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `focus5-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
            };

            const importData = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.investigators) {
                                const withCovenantPath = data.investigators.map(p => ({
                                    ...p,
                                    covenantPath: p.covenantPath || []
                                }));
                                setInvestigators(withCovenantPath);
                            }
                            if (data.lessActives) setLessActives(data.lessActives);
                            alert('Data imported successfully!');
                        } catch (error) {
                            alert('Error importing data. Please check the file format.');
                        }
                    };
                    reader.readAsText(file);
                }
            };

            // KPI Calculation Functions
            const getMonthsToAnalyze = () => {
                const now = new Date();
                const currentMonth = MONTHS[now.getMonth()];
                
                if (kpiView === 'current') {
                    return [currentMonth];
                } else if (kpiView === '3month') {
                    const monthIndex = now.getMonth();
                    const months = [];
                    for (let i = 2; i >= 0; i--) {
                        const index = (monthIndex - i + 12) % 12;
                        months.push(MONTHS[index]);
                    }
                    return months;
                } else if (kpiView === 'ytd') {
                    return MONTHS.slice(0, now.getMonth() + 1);
                } else if (kpiView === 'custom' && customStartDate && customEndDate) {
                    return MONTHS;
                }
                return [currentMonth];
            };

            const calculateKPIs = () => {
                const monthsToAnalyze = getMonthsToAnalyze();
                
                let totalInvitations = 0;
                let baptismReady = 0;
                let invitationCounts = {};
                let peopleWithActivity = new Set();
                
                investigators.forEach(person => {
                    if (!person.name) return;
                    
                    let hasBaptism = false;
                    monthsToAnalyze.forEach(month => {
                        const activities = person.months[month] || [];
                        activities.forEach(indicator => {
                            totalInvitations++;
                            invitationCounts[indicator] = (invitationCounts[indicator] || 0) + 1;
                            if (indicator === 'BC') hasBaptism = true;
                            if (activities.length > 0) peopleWithActivity.add(person.id);
                        });
                    });
                    
                    if (hasBaptism) baptismReady++;
                });

                const avgInvitationsPerPerson = investigators.filter(p => p.name).length > 0 
                    ? (totalInvitations / investigators.filter(p => p.name).length).toFixed(1)
                    : 0;

                const mostActiveInvitation = Object.keys(invitationCounts).length > 0
                    ? Object.keys(invitationCounts).reduce((a, b) => invitationCounts[a] > invitationCounts[b] ? a : b)
                    : 'N/A';

                let totalFellowship = 0;
                let fellowshipCounts = {};
                let lessActiveWithActivity = new Set();
                
                lessActives.forEach(person => {
                    if (!person.name) return;
                    
                    monthsToAnalyze.forEach(month => {
                        const activities = person.months[month] || [];
                        activities.forEach(indicator => {
                            totalFellowship++;
                            fellowshipCounts[indicator] = (fellowshipCounts[indicator] || 0) + 1;
                            if (activities.length > 0) lessActiveWithActivity.add(person.id);
                        });
                    });
                });

                const avgFellowshipPerFamily = lessActives.filter(p => p.name).length > 0
                    ? (totalFellowship / lessActives.filter(p => p.name).length).toFixed(1)
                    : 0;

                const mostCommonFellowship = Object.keys(fellowshipCounts).length > 0
                    ? Object.keys(fellowshipCounts).reduce((a, b) => fellowshipCounts[a] > fellowshipCounts[b] ? a : b)
                    : 'N/A';

                const totalPeopleTracked = investigators.filter(p => p.name).length + lessActives.filter(p => p.name).length;
                const totalActivities = totalInvitations + totalFellowship;

                return {
                    investigators: {
                        total: totalInvitations,
                        baptismReady,
                        mostActive: mostActiveInvitation,
                        avgPerPerson: avgInvitationsPerPerson,
                        peopleEngaged: peopleWithActivity.size,
                        breakdown: invitationCounts
                    },
                    lessActive: {
                        total: totalFellowship,
                        mostCommon: mostCommonFellowship,
                        avgPerFamily: avgFellowshipPerFamily,
                        peopleEngaged: lessActiveWithActivity.size,
                        breakdown: fellowshipCounts
                    },
                    overall: {
                        totalPeople: totalPeopleTracked,
                        totalActivities,
                        engagementRate: totalPeopleTracked > 0 
                            ? ((peopleWithActivity.size + lessActiveWithActivity.size) / totalPeopleTracked * 100).toFixed(0)
                            : 0
                    }
                };
            };

            const kpis = calculateKPIs();

            const renderPersonRow = (person, list, setList, indicators) => (
                <tr key={person.id} className="border-b hover:bg-gray-50">
                    <td className="p-2 border-r">
                        <input
                            type="text"
                            value={person.name}
                            onChange={(e) => updatePerson(list, setList, person.id, 'name', e.target.value)}
                            placeholder="Enter name..."
                            className="w-full px-2 py-1 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                    </td>
                    <td className="p-2 border-r">
                        <input
                            type="text"
                            value={person.assignment}
                            onChange={(e) => updatePerson(list, setList, person.id, 'assignment', e.target.value)}
                            placeholder="Assigned to..."
                            className="w-full px-2 py-1 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                    </td>
                    {MONTHS.map(month => (
                        <td 
                            key={month}
                            className="p-1 border-r text-center relative cursor-pointer hover:bg-blue-50 transition-colors"
                            onClick={(e) => {
                                const rect = e.currentTarget.getBoundingClientRect();
                                setShowPopup({
                                    personId: person.id,
                                    month,
                                    x: rect.left,
                                    y: rect.bottom,
                                    list,
                                    setList,
                                    indicators
                                });
                            }}
                        >
                            <div className="flex flex-wrap gap-1 justify-center min-h-[30px] items-center">
                                {(person.months[month] || []).map(indicatorId => {
                                    const indicator = indicators.find(i => i.id === indicatorId);
                                    if (!indicator) return null;
                                    return (
                                        <span
                                            key={indicatorId}
                                            className={`${indicator.color} text-white text-xs px-1.5 py-0.5 rounded font-semibold`}
                                            title={indicator.label}
                                        >
                                            {indicator.id}
                                        </span>
                                    );
                                })}
                            </div>
                        </td>
                    ))}
                    <td className="p-2">
                        <textarea
                            value={person.notes}
                            onChange={(e) => updatePerson(list, setList, person.id, 'notes', e.target.value)}
                            placeholder="Add notes..."
                            className="w-full px-2 py-1 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                            rows="2"
                        />
                    </td>
                </tr>
            );

            const getViewLabel = () => {
                if (kpiView === 'current') return 'This Month';
                if (kpiView === '3month') return 'Last 3 Months';
                if (kpiView === 'ytd') return 'Year to Date';
                if (kpiView === 'custom') return 'Custom Range';
                return 'This Month';
            };

            if (isLoading) {
                return (
                    <div className="flex items-center justify-center h-screen">
                        <div className="text-center">
                            <div className="text-4xl mb-4">üîÑ</div>
                            <div className="text-xl font-semibold text-gray-700">Loading Focus 5 Tracker...</div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    {/* Sync Status Indicator */}
                    <div className={`sync-indicator ${syncStatus} no-print`}>
                        {syncStatus === 'synced' ? (
                            <>
                                <span>‚úì</span>
                                <span>Synced</span>
                            </>
                        ) : (
                            <>
                                <span className="pulse">‚ü≥</span>
                                <span>Syncing...</span>
                            </>
                        )}
                    </div>

                    <div className="max-w-[1600px] mx-auto bg-white rounded-xl shadow-2xl overflow-hidden">
                        {/* Header */}
                        <div className="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6">
                            <h1 className="text-4xl font-bold mb-2">üìã Focus 5 Missionary Tracker - Live Sync</h1>
                            <p className="text-blue-100 text-lg">Real-time collaborative tracking for your ward's missionary efforts</p>
                            <p className="text-blue-200 text-sm mt-2 italic">"And if it so be that you should labor all your days in crying repentance unto this people, and bring, save it be one soul unto me, how great shall be your joy with him in the kingdom of my Father!" - D&C 18:15</p>
                        </div>

                        {/* Action Buttons */}
                        <div className="bg-gray-50 p-4 border-b flex flex-wrap gap-3 items-center justify-between no-print">
                            <div className="flex gap-3 flex-wrap">
                                <button
                                    onClick={exportData}
                                    className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold shadow-md transition-all flex items-center gap-2"
                                >
                                    üì• Export Backup
                                </button>
                                <label className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-semibold shadow-md transition-all flex items-center gap-2 cursor-pointer">
                                    üì§ Import Data
                                    <input
                                        type="file"
                                        accept=".json"
                                        onChange={importData}
                                        className="hidden"
                                    />
                                </label>
                                <button
                                    onClick={() => window.print()}
                                    className="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-semibold shadow-md transition-all flex items-center gap-2"
                                >
                                    üñ®Ô∏è Print
                                </button>
                            </div>
                            {lastSaved && (
                                <div className="text-sm text-gray-600">
                                    Last synced: {lastSaved.toLocaleString()}
                                </div>
                            )}
                        </div>

                        {/* KPI View Selector */}
                        <div className="bg-white p-4 border-b no-print">
                            <div className="flex flex-wrap gap-2 items-center">
                                <span className="font-semibold text-gray-700">KPI View:</span>
                                <button
                                    onClick={() => setKpiView('current')}
                                    className={`px-4 py-2 rounded-lg font-semibold transition-all ${kpiView === 'current' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                >
                                    üìÖ This Month
                                </button>
                                <button
                                    onClick={() => setKpiView('3month')}
                                    className={`px-4 py-2 rounded-lg font-semibold transition-all ${kpiView === '3month' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                >
                                    üìä Last 3 Months
                                </button>
                                <button
                                    onClick={() => setKpiView('ytd')}
                                    className={`px-4 py-2 rounded-lg font-semibold transition-all ${kpiView === 'ytd' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                >
                                    üìà Year to Date
                                </button>
                            </div>
                        </div>

                        {/* KPI Dashboard - Summary Cards */}
                        <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 no-print">
                            <h2 className="text-2xl font-bold mb-4 text-gray-800">üìä KPI Dashboard - {getViewLabel()}</h2>
                            
                            {/* Overall Metrics */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div className="bg-white rounded-lg shadow-md p-4 kpi-card">
                                    <div className="text-sm text-gray-600 font-semibold">Total People Tracked</div>
                                    <div className="text-3xl font-bold text-blue-600 mt-2">{kpis.overall.totalPeople}</div>
                                    <div className="text-xs text-gray-500 mt-1">Active Focus 5</div>
                                </div>
                                <div className="bg-white rounded-lg shadow-md p-4 kpi-card">
                                    <div className="text-sm text-gray-600 font-semibold">Total Activities</div>
                                    <div className="text-3xl font-bold text-green-600 mt-2">{kpis.overall.totalActivities}</div>
                                    <div className="text-xs text-gray-500 mt-1">Invitations + Fellowship</div>
                                </div>
                                <div className="bg-white rounded-lg shadow-md p-4 kpi-card">
                                    <div className="text-sm text-gray-600 font-semibold">Engagement Rate</div>
                                    <div className="text-3xl font-bold text-purple-600 mt-2">{kpis.overall.engagementRate}%</div>
                                    <div className="text-xs text-gray-500 mt-1">People with activity</div>
                                </div>
                            </div>

                            {/* Investigators Metrics */}
                            <div className="mb-6">
                                <h3 className="text-xl font-bold mb-3 text-gray-800">üéØ Current Investigators</h3>
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div className="bg-white rounded-lg shadow-md p-4 kpi-card">
                                        <div className="text-sm text-gray-600 font-semibold">Total Invitations</div>
                                        <div className="text-2xl font-bold text-blue-600 mt-2">{kpis.investigators.total}</div>
                                    </div>
                                    <div className="bg-white rounded-lg shadow-md p-4 kpi-card">
                                        <div className="text-sm text-gray-600 font-semibold">Baptisms Completed</div>
                                        <div className="text-2xl font-bold text-yellow-600 mt-2">{kpis.investigators.baptismReady}</div>
                                    </div>
                                    <div className="bg-white rounded-lg shadow-md p-4 kpi-card">
                                        <div className="text-sm text-gray-600 font-semibold">Most Active Invitation</div>
                                        <div className="text-2xl font-bold text-indigo-600 mt-2">{kpis.investigators.mostActive}</div>
                                    </div>
                                    <div className="bg-white rounded-lg shadow-md p-4 kpi-card">
                                        <div className="text-sm text-gray-600 font-semibold">Avg per Person</div>
                                        <div className="text-2xl font-bold text-green-600 mt-2">{kpis.investigators.avgPerPerson}</div>
                                    </div>
                                </div>
                            </div>

                            {/* Less Active Metrics */}
                            <div>
                                <h3 className="text-xl font-bold mb-3 text-gray-800">üíô Less Active / Part Member Families</h3>
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div className="bg-white rounded-lg shadow-md p-4 kpi-card">
                                        <div className="text-sm text-gray-600 font-semibold">Total Fellowship</div>
                                        <div className="text-2xl font-bold text-blue-600 mt-2">{kpis.lessActive.total}</div>
                                    </div>
                                    <div className="bg-white rounded-lg shadow-md p-4 kpi-card">
                                        <div className="text-sm text-gray-600 font-semibold">People Engaged</div>
                                        <div className="text-2xl font-bold text-green-600 mt-2">{kpis.lessActive.peopleEngaged}</div>
                                    </div>
                                    <div className="bg-white rounded-lg shadow-md p-4 kpi-card">
                                        <div className="text-sm text-gray-600 font-semibold">Most Common Activity</div>
                                        <div className="text-2xl font-bold text-purple-600 mt-2">{kpis.lessActive.mostCommon}</div>
                                    </div>
                                    <div className="bg-white rounded-lg shadow-md p-4 kpi-card">
                                        <div className="text-sm text-gray-600 font-semibold">Avg per Family</div>
                                        <div className="text-2xl font-bold text-pink-600 mt-2">{kpis.lessActive.avgPerFamily}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Legend for Investigators */}
                        <div className="bg-blue-50 p-4 border-b no-print">
                            <h3 className="font-bold text-lg mb-2 text-gray-800">üéØ Invitations Extended (for Investigators)</h3>
                            <div className="flex flex-wrap gap-3">
                                {INVESTIGATOR_INDICATORS.map(indicator => (
                                    <div key={indicator.id} className="flex items-center gap-2">
                                        <span className={`${indicator.color} text-white px-2 py-1 rounded font-semibold text-sm`}>
                                            {indicator.id}
                                        </span>
                                        <span className="text-sm text-gray-700">{indicator.label}</span>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Legend for Less Active */}
                        <div className="bg-indigo-50 p-4 border-b no-print">
                            <h3 className="font-bold text-lg mb-2 text-gray-800">üíô Fellowship Activities (for Less Active/Part Member Families)</h3>
                            <div className="flex flex-wrap gap-3">
                                {FELLOWSHIP_INDICATORS.map(indicator => (
                                    <div key={indicator.id} className="flex items-center gap-2">
                                        <span className={`${indicator.color} text-white px-2 py-1 rounded font-semibold text-sm`}>
                                            {indicator.id}
                                        </span>
                                        <span className="text-sm text-gray-700">{indicator.label}</span>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Investigators Table */}
                        <div className="p-6">
                            <h2 className="text-2xl font-bold mb-4 text-gray-800 flex items-center gap-2">
                                üéØ Current Investigators (Focus 5)
                            </h2>
                            <div className="overflow-x-auto border rounded-lg">
                                <table className="w-full border-collapse">
                                    <thead className="bg-blue-600 text-white">
                                        <tr>
                                            <th className="p-3 text-left border-r w-48">Name</th>
                                            <th className="p-3 text-left border-r w-48">Assigned To</th>
                                            {MONTHS.map(month => (
                                                <th key={month} className="p-3 text-center border-r w-24">{month}</th>
                                            ))}
                                            <th className="p-3 text-left w-64">Notes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {investigators.map(person => renderPersonRow(person, investigators, setInvestigators, INVESTIGATOR_INDICATORS))}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* Covenant Path Section */}
                        {investigators.some(p => p.name && hasBaptismCompleted(p)) && (
                            <div className="p-6 bg-gradient-to-r from-yellow-50 to-orange-50">
                                <h2 className="text-2xl font-bold mb-4 text-gray-800 flex items-center gap-2">
                                    ‚õ™ The Covenant Path - New Member Progress
                                </h2>
                                <p className="text-gray-600 mb-4 italic">Track each new member's journey along the covenant path</p>
                                
                                <div className="space-y-6">
                                    {investigators.filter(p => p.name && hasBaptismCompleted(p)).map(person => (
                                        <div key={person.id} className="bg-white rounded-lg shadow-md p-6 border-l-4 border-yellow-500">
                                            <h3 className="text-xl font-bold mb-4 text-gray-800 flex items-center gap-2">
                                                üåü {person.name}
                                            </h3>
                                            <div className="mb-3">
                                                <div className="flex items-center gap-2 text-sm text-gray-600">
                                                    <span className="font-semibold">Progress:</span>
                                                    <div className="flex-1 bg-gray-200 rounded-full h-3">
                                                        <div 
                                                            className="bg-gradient-to-r from-yellow-500 to-orange-500 h-3 rounded-full transition-all duration-500"
                                                            style={{
                                                                width: `${((person.covenantPath || []).length / COVENANT_PATH_ITEMS.length * 100).toFixed(0)}%`
                                                            }}
                                                        />
                                                    </div>
                                                    <span className="font-bold text-yellow-700">
                                                        {(person.covenantPath || []).length} / {COVENANT_PATH_ITEMS.length}
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                {COVENANT_PATH_ITEMS.map((item, index) => {
                                                    const isCompleted = (person.covenantPath || []).includes(item);
                                                    return (
                                                        <div 
                                                            key={index}
                                                            onClick={() => toggleCovenantPathItem(person.id, item)}
                                                            className={`flex items-start gap-3 p-3 rounded-lg cursor-pointer transition-all ${
                                                                isCompleted 
                                                                    ? 'bg-green-50 border-2 border-green-500' 
                                                                    : 'bg-gray-50 border-2 border-gray-300 hover:border-yellow-400'
                                                            }`}
                                                        >
                                                            <div className={`flex-shrink-0 w-6 h-6 rounded border-2 flex items-center justify-center ${
                                                                isCompleted 
                                                                    ? 'bg-green-500 border-green-500' 
                                                                    : 'bg-white border-gray-400'
                                                            }`}>
                                                                {isCompleted && (
                                                                    <svg className="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M5 13l4 4L19 7" />
                                                                    </svg>
                                                                )}
                                                            </div>
                                                            <span className={`text-sm flex-1 ${
                                                                isCompleted ? 'text-green-900 font-semibold' : 'text-gray-700'
                                                            }`}>
                                                                {item}
                                                            </span>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                <div className="bg-yellow-50 p-4 mt-6 rounded-lg border-l-4 border-yellow-600">
                                    <p className="text-yellow-900 italic text-sm">
                                        "And now, my beloved brethren, after ye have gotten into this strait and narrow path, I would ask if all is done? Behold, I say unto you, Nay; for ye have not come thus far save it were by the word of Christ with unshaken faith in him, relying wholly upon the merits of him who is mighty to save." - 2 Nephi 31:19
                                    </p>
                                </div>
                            </div>
                        )}

                        {/* Less Active Table */}
                        <div className="p-6">
                            <h2 className="text-2xl font-bold mb-4 text-gray-800 flex items-center gap-2">
                                üíô Less Active / Part Member Families (Focus 5)
                            </h2>
                            <div className="overflow-x-auto border rounded-lg">
                                <table className="w-full border-collapse">
                                    <thead className="bg-indigo-600 text-white">
                                        <tr>
                                            <th className="p-3 text-left border-r w-48">Name</th>
                                            <th className="p-3 text-left border-r w-48">Assigned To</th>
                                            {MONTHS.map(month => (
                                                <th key={month} className="p-3 text-center border-r w-24">{month}</th>
                                            ))}
                                            <th className="p-3 text-left w-64">Notes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {lessActives.map(person => renderPersonRow(person, lessActives, setLessActives, FELLOWSHIP_INDICATORS))}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* Detailed Analytics */}
                        <div className="bg-gray-50 p-6 no-print">
                            <h2 className="text-2xl font-bold mb-4 text-gray-800">üìà Detailed Analytics - {getViewLabel()}</h2>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {/* Invitation Breakdown */}
                                <div className="bg-white rounded-lg shadow-md p-4">
                                    <h3 className="font-bold text-lg mb-3 text-gray-800">Invitation Type Breakdown</h3>
                                    <div className="space-y-2">
                                        {Object.entries(kpis.investigators.breakdown).map(([key, value]) => {
                                            const indicator = INVESTIGATOR_INDICATORS.find(i => i.id === key);
                                            if (!indicator) return null;
                                            const percentage = kpis.investigators.total > 0 
                                                ? ((value / kpis.investigators.total) * 100).toFixed(0)
                                                : 0;
                                            return (
                                                <div key={key} className="flex items-center gap-3">
                                                    <span className={`${indicator.color} text-white px-2 py-1 rounded font-semibold text-xs w-16 text-center`}>
                                                        {indicator.id}
                                                    </span>
                                                    <div className="flex-1">
                                                        <div className="flex justify-between text-sm mb-1">
                                                            <span className="text-gray-700">{indicator.label}</span>
                                                            <span className="font-semibold">{value}</span>
                                                        </div>
                                                        <div className="w-full bg-gray-200 rounded-full h-2">
                                                            <div 
                                                                className={`${indicator.color} h-2 rounded-full`}
                                                                style={{width: `${percentage}%`}}
                                                            />
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                        {Object.keys(kpis.investigators.breakdown).length === 0 && (
                                            <p className="text-gray-500 text-sm">No invitations recorded yet</p>
                                        )}
                                    </div>
                                </div>

                                {/* Fellowship Breakdown */}
                                <div className="bg-white rounded-lg shadow-md p-4">
                                    <h3 className="font-bold text-lg mb-3 text-gray-800">Fellowship Activity Breakdown</h3>
                                    <div className="space-y-2">
                                        {Object.entries(kpis.lessActive.breakdown).map(([key, value]) => {
                                            const indicator = FELLOWSHIP_INDICATORS.find(i => i.id === key);
                                            if (!indicator) return null;
                                            const percentage = kpis.lessActive.total > 0 
                                                ? ((value / kpis.lessActive.total) * 100).toFixed(0)
                                                : 0;
                                            return (
                                                <div key={key} className="flex items-center gap-3">
                                                    <span className={`${indicator.color} text-white px-2 py-1 rounded font-semibold text-xs w-16 text-center`}>
                                                        {indicator.id}
                                                    </span>
                                                    <div className="flex-1">
                                                        <div className="flex justify-between text-sm mb-1">
                                                            <span className="text-gray-700">{indicator.label}</span>
                                                            <span className="font-semibold">{value}</span>
                                                        </div>
                                                        <div className="w-full bg-gray-200 rounded-full h-2">
                                                            <div 
                                                                className={`${indicator.color} h-2 rounded-full`}
                                                                style={{width: `${percentage}%`}}
                                                            />
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                        {Object.keys(kpis.lessActive.breakdown).length === 0 && (
                                            <p className="text-gray-500 text-sm">No fellowship activities recorded yet</p>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Instructions */}
                        <div className="bg-yellow-50 border-l-4 border-yellow-500 p-6 m-6 rounded-lg no-print">
                            <h3 className="font-bold text-lg text-yellow-900 mb-2">üí° How to Use (Live Sync Enabled!):</h3>
                            <ul className="text-sm text-yellow-800 space-y-1 list-disc list-inside">
                                <li><strong>Share the link</strong> - Everyone with this link can view and edit in real-time</li>
                                <li><strong>All changes sync automatically</strong> - Watch the sync indicator in the top-right</li>
                                <li><strong>No save button needed</strong> - Everything saves instantly to the cloud</li>
                                <li><strong>Click month cells</strong> to mark invitations/fellowship activities</li>
                                <li><strong>Mark "BC" (Baptism Completed)</strong> to unlock the Covenant Path section</li>
                                <li><strong>Track new member progress</strong> in the Covenant Path checklist</li>
                                <li><strong>Export backups regularly</strong> for offline records</li>
                            </ul>
                        </div>

                        {/* Scripture */}
                        <div className="bg-blue-50 p-6 m-6 rounded-lg border-l-4 border-blue-600">
                            <h3 className="font-bold text-lg text-blue-900 mb-2">üìñ Remember:</h3>
                            <p className="text-blue-800 italic">
                                "For behold the field is white already to harvest; and lo, he that thrusteth in his sickle with his might, the same layeth up in store that he perisheth not, but bringeth salvation to his soul" - D&C 4:4
                            </p>
                        </div>
                    </div>

                    {/* Indicator Popup */}
                    {showPopup && (
                        <div
                            ref={popupRef}
                            className="indicator-popup"
                            style={{
                                left: `${showPopup.x}px`,
                                top: `${showPopup.y + 5}px`
                            }}
                        >
                            <div className="text-sm font-bold text-gray-700 mb-3">
                                Select Activities for {showPopup.month}:
                            </div>
                            <div className="space-y-2">
                                {showPopup.indicators.map(indicator => {
                                    const person = showPopup.list.find(p => p.id === showPopup.personId);
                                    const isActive = (person.months[showPopup.month] || []).includes(indicator.id);
                                    
                                    return (
                                        <button
                                            key={indicator.id}
                                            onClick={() => toggleIndicator(
                                                showPopup.list,
                                                showPopup.setList,
                                                showPopup.personId,
                                                showPopup.month,
                                                indicator.id
                                            )}
                                            className={`indicator-btn w-full ${indicator.color} ${isActive ? 'opacity-100 ring-2 ring-offset-2 ring-blue-500' : 'opacity-60'} text-white px-3 py-2 rounded text-sm font-semibold text-left flex items-center justify-between`}
                                        >
                                            <span>{indicator.label}</span>
                                            <span className="font-bold">{indicator.id}</span>
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<Focus5Tracker />, document.getElementById('root'));
    </script>
</body>
</html>