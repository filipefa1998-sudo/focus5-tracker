<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus 5 Missionary Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        @media print { .no-print { display: none !important; } }
        .month-cell { min-width: 45px; cursor: pointer; transition: all 0.15s ease; }
        .month-cell:hover { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        .activity-badge { display: inline-block; padding: 2px 6px; margin: 1px; border-radius: 6px; font-size: 9px; font-weight: 600; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08); }
        .gradient-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-card { transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .pulse-dot { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        table { border-collapse: separate; border-spacing: 0; }
        table thead th { position: sticky; top: 0; z-index: 10; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .chart-container { position: relative; height: 300px; }
        .event-card { transition: all 0.3s ease; border-left: 4px solid transparent; }
        .event-card:hover { transform: translateX(4px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        .event-card.past { opacity: 0.6; }
        .event-card.upcoming { border-left-color: #10b981; }
        .event-card.soon { border-left-color: #f59e0b; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .calendar-day { min-height: 80px; padding: 4px; border: 1px solid #e5e7eb; }
        .calendar-day.other-month { opacity: 0.3; }
        .calendar-day.today { background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border: 2px solid #667eea; }
        .event-dot { width: 6px; height: 6px; border-radius: 50%; margin: 2px; }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 min-h-screen p-2 md:p-6">
    <div id="root">
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-center bg-white p-8 rounded-2xl shadow-xl">
                <div class="text-6xl mb-4">üì°</div>
                <p class="text-xl font-bold mb-2">Loading...</p>
                <p class="text-sm text-gray-600">Initializing tracker</p>
            </div>
        </div>
    </div>
    <div id="saveIndicator" style="position:fixed;bottom:20px;right:20px;z-index:1000;"></div>

    <!-- Firebase v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script>
        window.addEventListener('load', function() {
            if (typeof firebase === 'undefined') {
                document.getElementById('root').innerHTML = `
                    <div class="flex items-center justify-center min-h-screen">
                        <div class="text-center bg-white p-8 rounded-2xl shadow-xl max-w-md">
                            <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                            <p class="text-xl font-bold text-red-600 mb-2">Connection Error</p>
                            <p class="text-sm text-gray-600 mb-4">Failed to load Firebase. Please check your internet connection and refresh.</p>
                            <button onclick="location.reload()" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold">Refresh Page</button>
                        </div>
                    </div>
                `;
                return;
            }

            const firebaseConfig = {
                apiKey: "AIzaSyAMTk39-yO86IA36-ZzBCtpLswW4skCIH4",
                authDomain: "focus5-cd663.firebaseapp.com",
                databaseURL: "https://focus5-cd663-default-rtdb.firebaseio.com",
                projectId: "focus5-cd663"
            };

            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
            const dataRef = database.ref('trackerData');
            const eventsRef = database.ref('events');
            console.log('‚úÖ Firebase initialized');

            const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            const MONTH_NAMES_FULL = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            const DAYS = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const INVITATION_TYPES = {
                'RB':'Read Book of Mormon','AC':'Attend Church','AA':'Attend Activity','FHE':'Attend FHE',
                'TM':'Taught by Missionaries','PB':'Pray about BOM','BD':'Baptismal Date Set','BC':'Baptism Completed'
            };
            const FELLOWSHIP_TYPES = {
                'SRV':'Service','AI':'Activity Invited','AAT':'Activity Attended',
                'VIS':'Visit','IFH':'Invited to do Family History','TXT':'Text/Call'
            };
            const EVENT_TYPES = ['üèõÔ∏è Church Activity', 'üéâ Social Event', '‚öæ Sports/Recreation', 'üé≠ Cultural', 'ü§ù Service Project', 'üë®‚Äçüë©‚Äçüëß Family Activity', 'üéì Educational', 'üçΩÔ∏è Meal/Dinner', 'üìñ Scripture Study', 'üôè Spiritual', 'üéµ Music/Arts', 'üèÉ Youth Activity'];

            let state = {
                investigators: [],
                lessActive: [],
                events: [],
                kpiView: 'thisMonth',
                calendarView: 'list',
                currentCalendarMonth: new Date().getMonth(),
                currentCalendarYear: new Date().getFullYear(),
                loaded: false
            };
            let saveTimeout = null;
            let chartInstances = {};

            function fixData(item) {
                if (!item.monthlyData || !Array.isArray(item.monthlyData)) {
                    item.monthlyData = Array(12).fill().map(() => []);
                }
                while (item.monthlyData.length < 12) {
                    item.monthlyData.push([]);
                }
                item.monthlyData = item.monthlyData.map(m => Array.isArray(m) ? m : []);
                if (!item.covenantPath) {
                    item.covenantPath = {confirmation:false,holyGhost:false,sacrament:false,priesthood:false,temple:false,calling:false};
                }
                return item;
            }

            function saveToFirebase() {
                if (saveTimeout) clearTimeout(saveTimeout);
                const indicator = document.getElementById('saveIndicator');
                indicator.innerHTML = '<div class="bg-yellow-500 text-white px-4 py-2 rounded-full text-sm shadow-lg"><span class="pulse-dot inline-block w-2 h-2 bg-white rounded-full mr-2"></span>Syncing...</div>';
                saveTimeout = setTimeout(() => {
                    dataRef.set({
                        investigators: state.investigators,
                        lessActive: state.lessActive,
                        kpiView: state.kpiView,
                        lastSaved: firebase.database.ServerValue.TIMESTAMP
                    }).then(() => {
                        indicator.innerHTML = '<div class="bg-green-500 text-white px-4 py-2 rounded-full text-sm shadow-lg">‚úì Saved</div>';
                        setTimeout(() => { indicator.innerHTML = ''; }, 2000);
                    }).catch(err => {
                        console.error('Save error:', err);
                        indicator.innerHTML = '<div class="bg-red-500 text-white px-4 py-2 rounded-full text-sm shadow-lg">Failed</div>';
                    });
                }, 1000);
            }

            function saveEvents() {
                eventsRef.set(state.events).catch(err => console.error('Event save error:', err));
            }

            dataRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    state.investigators = (data.investigators || []).map(inv => fixData(inv));
                    state.lessActive = (data.lessActive || []).map(la => fixData(la));
                    state.kpiView = data.kpiView || 'thisMonth';
                }
                state.loaded = true;
                render();
            });

            eventsRef.on('value', (snapshot) => {
                const events = snapshot.val();
                state.events = events ? Object.keys(events).map(key => ({id: key, ...events[key]})) : [];
                if (state.loaded) render();
            });

            window.addInvestigator = function() {
                state.investigators.push({
                    id: Date.now(),
                    name: '',
                    assignedTo: '',
                    monthlyData: Array(12).fill().map(() => []),
                    notes: '',
                    covenantPath: {confirmation:false,holyGhost:false,sacrament:false,priesthood:false,temple:false,calling:false}
                });
                saveToFirebase();
                render();
            };

            window.addLessActive = function() {
                state.lessActive.push({
                    id: Date.now(),
                    name: '',
                    assignedTo: '',
                    monthlyData: Array(12).fill().map(() => []),
                    notes: ''
                });
                saveToFirebase();
                render();
            };

            window.updateField = function(type, id, field, value) {
                const list = type === 'investigator' ? state.investigators : state.lessActive;
                const item = list.find(i => i.id === id);
                if (item) {
                    if (field.startsWith('covenant_')) {
                        const covenantField = field.replace('covenant_', '');
                        item.covenantPath[covenantField] = value;
                    } else {
                        item[field] = value;
                    }
                    saveToFirebase();
                    render();
                }
            };

            window.toggleActivity = function(type, id, monthIndex, activityCode) {
                const list = type === 'investigator' ? state.investigators : state.lessActive;
                const item = list.find(i => i.id === id);
                if (item) {
                    const monthData = item.monthlyData[monthIndex];
                    const index = monthData.indexOf(activityCode);
                    if (index > -1) {
                        monthData.splice(index, 1);
                    } else {
                        monthData.push(activityCode);
                    }
                    saveToFirebase();
                    render();
                }
            };

            window.deleteItem = function(type, id) {
                if (!confirm('Delete this entry?')) return;
                if (type === 'investigator') {
                    state.investigators = state.investigators.filter(i => i.id !== id);
                } else {
                    state.lessActive = state.lessActive.filter(i => i.id !== id);
                }
                saveToFirebase();
                render();
            };

            window.changeKPIView = function(view) {
                state.kpiView = view;
                saveToFirebase();
                render();
            };

            window.changeCalendarView = function(view) {
                state.calendarView = view;
                render();
            };

            window.changeCalendarMonth = function(delta) {
                state.currentCalendarMonth += delta;
                if (state.currentCalendarMonth < 0) {
                    state.currentCalendarMonth = 11;
                    state.currentCalendarYear--;
                } else if (state.currentCalendarMonth > 11) {
                    state.currentCalendarMonth = 0;
                    state.currentCalendarYear++;
                }
                render();
            };

            window.addEvent = function() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                modal.innerHTML = `
                    <div class="glass-card rounded-2xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="text-4xl">üìÖ</div>
                            <h3 class="font-bold text-2xl">Add Ward Event</h3>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Event Name *</label>
                                <input id="eventName" type="text" placeholder="e.g., Ward BBQ, Youth Activity" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none">
                            </div>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Date *</label>
                                    <input id="eventDate" type="date" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Time</label>
                                    <input id="eventTime" type="time" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Location</label>
                                <input id="eventLocation" type="text" placeholder="Church building, Park, etc." class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Event Type</label>
                                <select id="eventType" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none">
                                    ${EVENT_TYPES.map(type => `<option value="${type}">${type}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Description</label>
                                <textarea id="eventDescription" rows="3" placeholder="Event details, who to invite, what to bring..." class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none"></textarea>
                            </div>
                            <div class="bg-indigo-50 rounded-xl p-4">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input id="eventInviteReady" type="checkbox" class="w-5 h-5 text-indigo-600 rounded">
                                    <span class="text-sm font-medium">‚ú® This event is great for inviting investigators</span>
                                </label>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-xl font-semibold hover:bg-gray-300">Cancel</button>
                            <button onclick="saveNewEvent()" class="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-3 rounded-xl font-semibold hover:shadow-lg">Add Event</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Set default date to today
                document.getElementById('eventDate').valueAsDate = new Date();
            };

            window.saveNewEvent = function() {
                const name = document.getElementById('eventName').value.trim();
                const date = document.getElementById('eventDate').value;
                const time = document.getElementById('eventTime').value;
                const location = document.getElementById('eventLocation').value.trim();
                const type = document.getElementById('eventType').value;
                const description = document.getElementById('eventDescription').value.trim();
                const inviteReady = document.getElementById('eventInviteReady').checked;

                if (!name || !date) {
                    alert('Please enter an event name and date');
                    return;
                }

                const newEvent = {
                    id: Date.now().toString(),
                    name,
                    date,
                    time,
                    location,
                    type,
                    description,
                    inviteReady,
                    createdAt: new Date().toISOString()
                };

                eventsRef.child(newEvent.id).set(newEvent);
                document.querySelector('.fixed').remove();
            };

            window.editEvent = function(eventId) {
                const event = state.events.find(e => e.id === eventId);
                if (!event) return;

                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                modal.innerHTML = `
                    <div class="glass-card rounded-2xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="text-4xl">‚úèÔ∏è</div>
                            <h3 class="font-bold text-2xl">Edit Event</h3>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Event Name *</label>
                                <input id="editEventName" type="text" value="${event.name}" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none">
                            </div>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Date *</label>
                                    <input id="editEventDate" type="date" value="${event.date}" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Time</label>
                                    <input id="editEventTime" type="time" value="${event.time || ''}" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Location</label>
                                <input id="editEventLocation" type="text" value="${event.location || ''}" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Event Type</label>
                                <select id="editEventType" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none">
                                    ${EVENT_TYPES.map(type => `<option value="${type}" ${event.type === type ? 'selected' : ''}>${type}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Description</label>
                                <textarea id="editEventDescription" rows="3" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none">${event.description || ''}</textarea>
                            </div>
                            <div class="bg-indigo-50 rounded-xl p-4">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input id="editEventInviteReady" type="checkbox" ${event.inviteReady ? 'checked' : ''} class="w-5 h-5 text-indigo-600 rounded">
                                    <span class="text-sm font-medium">‚ú® This event is great for inviting investigators</span>
                                </label>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-6">
                            <button onclick="deleteEvent('${eventId}')" class="bg-red-500 text-white px-6 py-3 rounded-xl font-semibold hover:bg-red-600">Delete</button>
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-xl font-semibold hover:bg-gray-300">Cancel</button>
                            <button onclick="updateEvent('${eventId}')" class="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-3 rounded-xl font-semibold hover:shadow-lg">Save</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            };

            window.updateEvent = function(eventId) {
                const name = document.getElementById('editEventName').value.trim();
                const date = document.getElementById('editEventDate').value;
                const time = document.getElementById('editEventTime').value;
                const location = document.getElementById('editEventLocation').value.trim();
                const type = document.getElementById('editEventType').value;
                const description = document.getElementById('editEventDescription').value.trim();
                const inviteReady = document.getElementById('editEventInviteReady').checked;

                if (!name || !date) {
                    alert('Please enter an event name and date');
                    return;
                }

                eventsRef.child(eventId).update({
                    name, date, time, location, type, description, inviteReady
                });
                document.querySelector('.fixed').remove();
            };

            window.deleteEvent = function(eventId) {
                if (!confirm('Delete this event?')) return;
                eventsRef.child(eventId).remove();
                document.querySelector('.fixed').remove();
            };

            window.exportData = function() {
                const data = {
                    investigators: state.investigators,
                    lessActive: state.lessActive,
                    events: state.events,
                    exportDate: new Date().toISOString()
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `focus5-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            function calculateKPIs() {
                const now = new Date();
                const currentMonth = now.getMonth();
                let activeMonths = [];
                switch(state.kpiView) {
                    case 'thisMonth': activeMonths = [currentMonth]; break;
                    case 'last3Months': activeMonths = [(currentMonth-2+12)%12, (currentMonth-1+12)%12, currentMonth]; break;
                    case 'yearToDate': activeMonths = Array.from({length: currentMonth + 1}, (_, i) => i); break;
                }

                const invitationCounts = {};
                let totalInvitations = 0, baptismsCompleted = 0;
                state.investigators.forEach(inv => {
                    activeMonths.forEach(month => {
                        if (inv.monthlyData && inv.monthlyData[month]) {
                            inv.monthlyData[month].forEach(code => {
                                invitationCounts[code] = (invitationCounts[code] || 0) + 1;
                                totalInvitations++;
                                if (code === 'BC') baptismsCompleted++;
                            });
                        }
                    });
                });

                const fellowshipCounts = {};
                let totalFellowship = 0, peopleEngaged = 0;
                state.lessActive.forEach(person => {
                    let hasActivity = false;
                    activeMonths.forEach(month => {
                        if (person.monthlyData && person.monthlyData[month]) {
                            person.monthlyData[month].forEach(code => {
                                fellowshipCounts[code] = (fellowshipCounts[code] || 0) + 1;
                                totalFellowship++;
                                hasActivity = true;
                            });
                        }
                    });
                    if (hasActivity) peopleEngaged++;
                });

                const mostActiveInvitation = Object.keys(invitationCounts).reduce((a, b) => invitationCounts[a] > invitationCounts[b] ? a : b, 'None');
                const mostCommonFellowship = Object.keys(fellowshipCounts).reduce((a, b) => fellowshipCounts[a] > fellowshipCounts[b] ? a : b, 'None');
                const activeFocus5 = state.investigators.filter(inv => inv.monthlyData && activeMonths.some(month => inv.monthlyData[month] && inv.monthlyData[month].length > 0)).length + state.lessActive.filter(person => person.monthlyData && activeMonths.some(month => person.monthlyData[month] && person.monthlyData[month].length > 0)).length;
                const totalActivities = totalInvitations + totalFellowship;
                const totalPeople = state.investigators.length + state.lessActive.length;
                const engagementRate = totalPeople > 0 ? Math.round(((state.investigators.filter(inv => inv.monthlyData && activeMonths.some(month => inv.monthlyData[month] && inv.monthlyData[month].length > 0)).length + peopleEngaged) / totalPeople) * 100) : 0;

                return {
                    totalPeople, activeFocus5, totalActivities, engagementRate,
                    investigators: {totalInvitations, baptismsCompleted, mostActiveInvitation, avgPerPerson: state.investigators.length > 0 ? (totalInvitations / state.investigators.length).toFixed(1) : 0, breakdown: invitationCounts},
                    lessActive: {totalFellowship, peopleEngaged, mostCommonFellowship, avgPerFamily: state.lessActive.length > 0 ? (totalFellowship / state.lessActive.length).toFixed(1) : 0, breakdown: fellowshipCounts}
                };
            }

            window.showActivityModal = function(type, id, monthIndex) {
                const list = type === 'investigator' ? state.investigators : state.lessActive;
                const item = list.find(i => i.id === id);
                const activities = item.monthlyData[monthIndex] || [];
                const activityTypes = type === 'investigator' ? INVITATION_TYPES : FELLOWSHIP_TYPES;
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                modal.innerHTML = `
                    <div class="glass-card rounded-2xl p-8 max-w-md w-full max-h-[80vh] overflow-y-auto shadow-2xl">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="text-3xl">${type === 'investigator' ? 'üéØ' : 'üíô'}</div>
                            <div><h3 class="font-bold text-xl">${MONTHS[monthIndex]}</h3><p class="text-sm text-gray-600">${item.name || 'New Entry'}</p></div>
                        </div>
                        <div class="space-y-2">
                            ${Object.entries(activityTypes).map(([code, label]) => `
                                <label class="flex items-center gap-4 p-4 hover:bg-gradient-to-r ${type === 'investigator' ? 'from-indigo-50 to-purple-50' : 'from-blue-50 to-cyan-50'} rounded-xl cursor-pointer transition-all">
                                    <input type="checkbox" ${activities.includes(code) ? 'checked' : ''} onchange="toggleActivity('${type}', ${id}, ${monthIndex}, '${code}'); this.closest('.fixed').remove();" class="w-6 h-6 text-${type === 'investigator' ? 'indigo' : 'blue'}-600 rounded-lg">
                                    <div class="flex-1"><span class="font-bold text-${type === 'investigator' ? 'indigo' : 'blue'}-700 bg-white px-3 py-1 rounded-lg text-sm">${code}</span><span class="text-gray-700 ml-2">${label}</span></div>
                                </label>
                            `).join('')}
                        </div>
                        <button onclick="this.closest('.fixed').remove()" class="mt-6 w-full bg-gradient-to-r from-gray-600 to-gray-700 text-white px-6 py-3 rounded-xl font-semibold">Close</button>
                    </div>
                `;
                document.body.appendChild(modal);
            };

            function renderCharts(kpis) {
                setTimeout(() => {
                    if (chartInstances.inv) chartInstances.inv.destroy();
                    if (chartInstances.fel) chartInstances.fel.destroy();
                    if (chartInstances.prog) chartInstances.prog.destroy();

                    const invCtx = document.getElementById('invitationPieChart');
                    if (invCtx && Object.keys(kpis.investigators.breakdown).length > 0) {
                        chartInstances.inv = new Chart(invCtx, {
                            type: 'doughnut',
                            data: {labels: Object.keys(kpis.investigators.breakdown), datasets: [{data: Object.values(kpis.investigators.breakdown), backgroundColor: ['#6366f1','#8b5cf6','#ec4899','#f59e0b','#10b981','#3b82f6','#ef4444','#14b8a6'], borderWidth: 0}]},
                            options: {responsive: true, maintainAspectRatio: false, plugins: {legend: {position: 'bottom', labels: {padding: 15, font: {size: 11}}}}}
                        });
                    }

                    const felCtx = document.getElementById('fellowshipPieChart');
                    if (felCtx && Object.keys(kpis.lessActive.breakdown).length > 0) {
                        chartInstances.fel = new Chart(felCtx, {
                            type: 'doughnut',
                            data: {labels: Object.keys(kpis.lessActive.breakdown), datasets: [{data: Object.values(kpis.lessActive.breakdown), backgroundColor: ['#3b82f6','#06b6d4','#10b981','#f59e0b','#ec4899','#8b5cf6','#ef4444','#14b8a6'], borderWidth: 0}]},
                            options: {responsive: true, maintainAspectRatio: false, plugins: {legend: {position: 'bottom', labels: {padding: 15, font: {size: 11}}}}}
                        });
                    }

                    const progCtx = document.getElementById('progressBarChart');
                    if (progCtx) {
                        chartInstances.prog = new Chart(progCtx, {
                            type: 'bar',
                            data: {labels: ['Investigators', 'Less Active', 'Total Activities'], datasets: [{label: 'Count', data: [state.investigators.length, state.lessActive.length, kpis.totalActivities], backgroundColor: ['rgba(99,102,241,0.8)','rgba(59,130,246,0.8)','rgba(16,185,129,0.8)'], borderRadius: 8, borderWidth: 0}]},
                            options: {responsive: true, maintainAspectRatio: false, plugins: {legend: {display: false}}, scales: {y: {beginAtZero: true, grid: {color: 'rgba(0,0,0,0.05)'}}, x: {grid: {display: false}}}}
                        });
                    }
                }, 100);
            }

            function renderCalendar() {
                const firstDay = new Date(state.currentCalendarYear, state.currentCalendarMonth, 1);
                const lastDay = new Date(state.currentCalendarYear, state.currentCalendarMonth + 1, 0);
                const startingDayOfWeek = firstDay.getDay();
                const daysInMonth = lastDay.getDate();
                
                const prevMonth = new Date(state.currentCalendarYear, state.currentCalendarMonth, 0);
                const daysInPrevMonth = prevMonth.getDate();
                
                const today = new Date();
                const isCurrentMonth = today.getMonth() === state.currentCalendarMonth && today.getFullYear() === state.currentCalendarYear;
                const todayDate = today.getDate();

                let calendarHTML = '<div class="calendar-grid">';
                
                // Day headers
                DAYS.forEach(day => {
                    calendarHTML += `<div class="text-center font-bold text-sm text-gray-600 py-2">${day}</div>`;
                });

                // Previous month days
                for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                    calendarHTML += `<div class="calendar-day other-month text-gray-400 text-sm">${daysInPrevMonth - i}</div>`;
                }

                // Current month days
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${state.currentCalendarYear}-${String(state.currentCalendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayEvents = state.events.filter(e => e.date === dateStr);
                    const isToday = isCurrentMonth && day === todayDate;
                    
                    calendarHTML += `
                        <div class="calendar-day ${isToday ? 'today' : ''} bg-white rounded-lg">
                            <div class="font-semibold text-sm mb-1">${day}</div>
                            <div class="space-y-1">
                                ${dayEvents.map(event => {
                                    const emoji = event.type.split(' ')[0];
                                    return `
                                        <div onclick="editEvent('${event.id}')" class="text-xs p-1 bg-indigo-100 rounded cursor-pointer hover:bg-indigo-200 truncate" title="${event.name}">
                                            ${emoji} ${event.time || ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }

                // Next month days to fill grid
                const totalCells = startingDayOfWeek + daysInMonth;
                const remainingCells = 42 - totalCells; // 6 rows * 7 days
                for (let day = 1; day <= remainingCells; day++) {
                    calendarHTML += `<div class="calendar-day other-month text-gray-400 text-sm">${day}</div>`;
                }

                calendarHTML += '</div>';
                return calendarHTML;
            }

            function renderEventsList() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const sortedEvents = [...state.events].sort((a, b) => new Date(a.date) - new Date(b.date));
                const upcomingEvents = sortedEvents.filter(e => new Date(e.date) >= today);
                const pastEvents = sortedEvents.filter(e => new Date(e.date) < today).reverse();

                if (sortedEvents.length === 0) {
                    return `
                        <div class="text-center py-12 text-gray-400">
                            <div class="text-6xl mb-4">üìÖ</div>
                            <p class="text-lg">No events scheduled yet</p>
                            <p class="text-sm mt-2">Click "Add Event" to get started</p>
                        </div>
                    `;
                }

                let html = '';

                if (upcomingEvents.length > 0) {
                    html += '<div class="mb-8"><h3 class="text-xl font-bold text-indigo-900 mb-4">üìÜ Upcoming Events</h3><div class="space-y-3">';
                    upcomingEvents.forEach(event => {
                        const eventDate = new Date(event.date);
                        const daysUntil = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24));
                        const isSoon = daysUntil <= 7;
                        
                        html += `
                            <div class="event-card ${isSoon ? 'soon' : 'upcoming'} bg-white rounded-xl p-4 cursor-pointer hover:shadow-lg" onclick="editEvent('${event.id}')">
                                <div class="flex items-start gap-4">
                                    <div class="text-3xl">${event.type.split(' ')[0]}</div>
                                    <div class="flex-1">
                                        <div class="flex items-start justify-between">
                                            <div>
                                                <h4 class="font-bold text-lg">${event.name}</h4>
                                                <p class="text-sm text-gray-600">${new Date(event.date).toLocaleDateString('en-US', {weekday: 'long', month: 'long', day: 'numeric', year: 'numeric'})} ${event.time ? `at ${event.time}` : ''}</p>
                                                ${event.location ? `<p class="text-sm text-gray-500">üìç ${event.location}</p>` : ''}
                                            </div>
                                            ${isSoon ? `<span class="bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-xs font-semibold">${daysUntil === 0 ? 'Today!' : daysUntil === 1 ? 'Tomorrow' : `${daysUntil} days`}</span>` : `<span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-semibold">${daysUntil} days</span>`}
                                        </div>
                                        ${event.description ? `<p class="text-sm text-gray-700 mt-2">${event.description}</p>` : ''}
                                        ${event.inviteReady ? '<div class="mt-2"><span class="inline-flex items-center gap-1 bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-semibold">‚ú® Great for inviting investigators</span></div>' : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div></div>';
                }

                if (pastEvents.length > 0) {
                    html += '<div><h3 class="text-xl font-bold text-gray-600 mb-4">üìú Past Events</h3><div class="space-y-3">';
                    pastEvents.slice(0, 10).forEach(event => {
                        html += `
                            <div class="event-card past bg-white rounded-xl p-4 cursor-pointer hover:shadow-lg" onclick="editEvent('${event.id}')">
                                <div class="flex items-start gap-4">
                                    <div class="text-2xl opacity-60">${event.type.split(' ')[0]}</div>
                                    <div class="flex-1">
                                        <h4 class="font-semibold">${event.name}</h4>
                                        <p class="text-sm text-gray-500">${new Date(event.date).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})} ${event.time ? `at ${event.time}` : ''}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    if (pastEvents.length > 10) {
                        html += `<p class="text-center text-sm text-gray-500 mt-4">+ ${pastEvents.length - 10} more past events</p>`;
                    }
                    html += '</div></div>';
                }

                return html;
            }

            function render() {
                if (!state.loaded) {
                    document.getElementById('root').innerHTML = '<div class="flex items-center justify-center min-h-screen"><div class="text-center bg-white p-8 rounded-2xl shadow-xl"><div class="text-6xl mb-4">üì°</div><p class="text-xl font-bold mb-2">Connecting...</p></div></div>';
                    return;
                }

                const kpis = calculateKPIs();
                const viewLabel = {'thisMonth': 'This Month', 'last3Months': 'Last 3 Months', 'yearToDate': 'Year to Date'}[state.kpiView];

                document.getElementById('root').innerHTML = `
                    <div class="max-w-[1600px] mx-auto space-y-6">
                        <div class="glass-card rounded-2xl shadow-2xl p-6 md:p-8 gradient-header text-white">
                            <div class="text-center">
                                <div class="text-6xl mb-2">üìã</div>
                                <h1 class="text-3xl md:text-5xl font-bold mb-3">Focus 5 Missionary Tracker</h1>
                                <p class="text-lg text-indigo-100 mb-4">Track your ward's missionary efforts & events</p>
                                <div class="max-w-3xl mx-auto bg-white/10 rounded-xl p-4 mb-4">
                                    <p class="text-sm italic">"And if it so be that you should labor all your days in crying repentance unto this people, and bring, save it be one soul unto me, how great shall be your joy with him in the kingdom of my Father!"</p>
                                    <p class="text-xs mt-2 text-indigo-200">‚Äî D&C 18:15</p>
                                </div>
                                <div class="flex flex-wrap justify-center gap-3 no-print">
                                    <button onclick="exportData()" class="bg-white/20 hover:bg-white/30 text-white px-5 py-2.5 rounded-xl text-sm font-semibold transition-all hover:scale-105 shadow-lg">üì• Export</button>
                                    <button onclick="window.print()" class="bg-white/20 hover:bg-white/30 text-white px-5 py-2.5 rounded-xl text-sm font-semibold transition-all hover:scale-105 shadow-lg">üñ®Ô∏è Print</button>
                                </div>
                                <div class="mt-4"><div class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-green-500/20 text-green-100 border border-green-300/30">üîÑ Live Sync Active</div></div>
                            </div>
                        </div>

                        <!-- Events Calendar Section -->
                        <div class="glass-card rounded-2xl shadow-xl p-6">
                            <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                                <div class="flex items-center gap-3">
                                    <div class="text-4xl">üìÖ</div>
                                    <h2 class="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">Ward Events Calendar</h2>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="changeCalendarView('list')" class="${state.calendarView === 'list' ? 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg' : 'bg-gray-100 text-gray-700'} px-4 py-2.5 rounded-xl text-sm font-semibold transition-all hover:scale-105">üìã List</button>
                                    <button onclick="changeCalendarView('calendar')" class="${state.calendarView === 'calendar' ? 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg' : 'bg-gray-100 text-gray-700'} px-4 py-2.5 rounded-xl text-sm font-semibold transition-all hover:scale-105">üìÜ Calendar</button>
                                    <button onclick="addEvent()" class="bg-gradient-to-r from-green-600 to-emerald-600 text-white px-5 py-2.5 rounded-xl text-sm font-semibold transition-all hover:scale-105 shadow-lg no-print">+ Add Event</button>
                                </div>
                            </div>

                            ${state.calendarView === 'calendar' ? `
                                <div class="mb-4 flex items-center justify-between bg-indigo-50 rounded-xl p-4">
                                    <button onclick="changeCalendarMonth(-1)" class="p-2 hover:bg-white rounded-lg transition-all">‚óÄ</button>
                                    <h3 class="text-xl font-bold text-indigo-900">${MONTH_NAMES_FULL[state.currentCalendarMonth]} ${state.currentCalendarYear}</h3>
                                    <button onclick="changeCalendarMonth(1)" class="p-2 hover:bg-white rounded-lg transition-all">‚ñ∂</button>
                                </div>
                                ${renderCalendar()}
                            ` : renderEventsList()}

                            <div class="mt-6 bg-indigo-50 rounded-xl p-4">
                                <div class="flex items-start gap-3">
                                    <div class="text-2xl">üí°</div>
                                    <div class="flex-1">
                                        <p class="font-semibold text-indigo-900 mb-2">Using the Events Calendar:</p>
                                        <ul class="text-sm text-gray-700 space-y-1">
                                            <li>‚ú® Mark events as "Great for inviting investigators" to highlight invitation opportunities</li>
                                            <li>üìÖ Click any event to edit details or remove it</li>
                                            <li>üîÑ All changes sync live - everyone with the link sees updates immediately</li>
                                            <li>üì± Share events with investigators via text or during visits</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="glass-card rounded-2xl shadow-xl p-4 no-print">
                            <div class="flex flex-wrap items-center gap-3">
                                <span class="font-semibold text-gray-700">üìä View:</span>
                                <button onclick="changeKPIView('thisMonth')" class="${state.kpiView === 'thisMonth' ? 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg' : 'bg-gray-100 text-gray-700'} px-4 py-2.5 rounded-xl text-sm font-semibold transition-all hover:scale-105">üìÖ This Month</button>
                                <button onclick="changeKPIView('last3Months')" class="${state.kpiView === 'last3Months' ? 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg' : 'bg-gray-100 text-gray-700'} px-4 py-2.5 rounded-xl text-sm font-semibold transition-all hover:scale-105">üìä Last 3 Months</button>
                                <button onclick="changeKPIView('yearToDate')" class="${state.kpiView === 'yearToDate' ? 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg' : 'bg-gray-100 text-gray-700'} px-4 py-2.5 rounded-xl text-sm font-semibold transition-all hover:scale-105">üìà Year to Date</button>
                            </div>
                        </div>

                        <div class="glass-card rounded-2xl shadow-xl p-6 md:p-8">
                            <h2 class="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-6">üìä KPI Dashboard ‚Äî ${viewLabel}</h2>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                                <div class="stat-card bg-gradient-to-br from-blue-500 to-cyan-500 rounded-2xl p-6 text-white shadow-lg"><div class="text-4xl mb-2">üë•</div><p class="text-sm opacity-90 mb-1">Total People</p><p class="text-4xl font-bold">${kpis.totalPeople}</p></div>
                                <div class="stat-card bg-gradient-to-br from-green-500 to-emerald-500 rounded-2xl p-6 text-white shadow-lg"><div class="text-4xl mb-2">‚≠ê</div><p class="text-sm opacity-90 mb-1">Active Focus 5</p><p class="text-4xl font-bold">${kpis.activeFocus5}</p></div>
                                <div class="stat-card bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl p-6 text-white shadow-lg"><div class="text-4xl mb-2">üìà</div><p class="text-sm opacity-90 mb-1">Total Activities</p><p class="text-4xl font-bold">${kpis.totalActivities}</p></div>
                                <div class="stat-card bg-gradient-to-br from-orange-500 to-red-500 rounded-2xl p-6 text-white shadow-lg"><div class="text-4xl mb-2">üéØ</div><p class="text-sm opacity-90 mb-1">Engagement</p><p class="text-4xl font-bold">${kpis.engagementRate}%</p></div>
                            </div>
                            <div class="grid md:grid-cols-2 gap-6">
                                <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-2xl p-6">
                                    <div class="flex items-center gap-3 mb-4"><div class="text-4xl">üéØ</div><h3 class="font-bold text-indigo-900">Current Investigators</h3></div>
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div class="bg-white/60 rounded-xl p-4 text-center"><div class="text-xs text-gray-600">Total Invitations</div><div class="text-3xl font-bold text-indigo-600">${kpis.investigators.totalInvitations}</div></div>
                                        <div class="bg-white/60 rounded-xl p-4 text-center"><div class="text-xs text-gray-600">Baptisms</div><div class="text-3xl font-bold text-green-600">${kpis.investigators.baptismsCompleted}</div></div>
                                        <div class="bg-white/60 rounded-xl p-4 text-center"><div class="text-xs text-gray-600">Most Active</div><div class="text-2xl font-bold text-purple-600">${kpis.investigators.mostActiveInvitation}</div></div>
                                        <div class="bg-white/60 rounded-xl p-4 text-center"><div class="text-xs text-gray-600">Avg/Person</div><div class="text-2xl font-bold text-orange-600">${kpis.investigators.avgPerPerson}</div></div>
                                    </div>
                                </div>
                                <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-2xl p-6">
                                    <div class="flex items-center gap-3 mb-4"><div class="text-4xl">üíô</div><h3 class="font-bold text-blue-900">Less Active Members</h3></div>
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div class="bg-white/60 rounded-xl p-4 text-center"><div class="text-xs text-gray-600">Total Fellowship</div><div class="text-3xl font-bold text-blue-600">${kpis.lessActive.totalFellowship}</div></div>
                                        <div class="bg-white/60 rounded-xl p-4 text-center"><div class="text-xs text-gray-600">People Engaged</div><div class="text-3xl font-bold text-cyan-600">${kpis.lessActive.peopleEngaged}</div></div>
                                        <div class="bg-white/60 rounded-xl p-4 text-center"><div class="text-xs text-gray-600">Most Common</div><div class="text-2xl font-bold text-purple-600">${kpis.lessActive.mostCommonFellowship}</div></div>
                                        <div class="bg-white/60 rounded-xl p-4 text-center"><div class="text-xs text-gray-600">Avg/Family</div><div class="text-2xl font-bold text-orange-600">${kpis.lessActive.avgPerFamily}</div></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="glass-card rounded-2xl shadow-xl p-6">
                            <h2 class="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-6">üìä Visual Analytics</h2>
                            <div class="grid md:grid-cols-3 gap-6">
                                <div class="bg-indigo-50 rounded-2xl p-6"><h3 class="font-bold text-indigo-900 mb-4 text-center">Invitation Types</h3><div class="chart-container"><canvas id="invitationPieChart"></canvas></div></div>
                                <div class="bg-blue-50 rounded-2xl p-6"><h3 class="font-bold text-blue-900 mb-4 text-center">Fellowship Activities</h3><div class="chart-container"><canvas id="fellowshipPieChart"></canvas></div></div>
                                <div class="bg-green-50 rounded-2xl p-6"><h3 class="font-bold text-green-900 mb-4 text-center">Progress Overview</h3><div class="chart-container"><canvas id="progressBarChart"></canvas></div></div>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="glass-card rounded-2xl shadow-xl p-6">
                                <div class="flex items-center gap-3 mb-4"><div class="text-3xl">üéØ</div><h3 class="font-bold text-indigo-900">Invitations Extended</h3></div>
                                <div class="grid grid-cols-2 gap-3 text-xs">${Object.entries(INVITATION_TYPES).map(([code, label]) => `<div class="flex items-center gap-2 bg-indigo-50 px-3 py-2 rounded-lg"><span class="font-bold text-indigo-700 bg-white px-2 py-1 rounded">${code}</span><span class="text-gray-700">${label}</span></div>`).join('')}</div>
                            </div>
                            <div class="glass-card rounded-2xl shadow-xl p-6">
                                <div class="flex items-center gap-3 mb-4"><div class="text-3xl">üíô</div><h3 class="font-bold text-blue-900">Fellowship Activities</h3></div>
                                <div class="grid grid-cols-2 gap-3 text-xs">${Object.entries(FELLOWSHIP_TYPES).map(([code, label]) => `<div class="flex items-center gap-2 bg-blue-50 px-3 py-2 rounded-lg"><span class="font-bold text-blue-700 bg-white px-2 py-1 rounded">${code}</span><span class="text-gray-700">${label}</span></div>`).join('')}</div>
                            </div>
                        </div>

                        <div class="glass-card rounded-2xl shadow-xl p-6">
                            <div class="flex justify-between items-center mb-6">
                                <div class="flex items-center gap-3"><div class="text-3xl">üéØ</div><h2 class="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">Current Investigators</h2></div>
                                <button onclick="addInvestigator()" class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-5 py-2.5 rounded-xl text-sm font-semibold transition-all hover:scale-105 shadow-lg no-print">+ Add Investigator</button>
                            </div>
                            <div class="overflow-x-auto rounded-xl">
                                <table class="w-full text-xs">
                                    <thead><tr><th class="p-3 text-left">Name</th><th class="p-3 text-left">Assigned</th>${MONTHS.map(m => `<th class="p-2">${m}</th>`).join('')}<th class="p-3">Notes</th><th class="p-3 no-print"></th></tr></thead>
                                    <tbody class="bg-white">
                                        ${state.investigators.length === 0 ? '<tr><td colspan="15" class="text-center py-12 text-gray-400"><div class="text-6xl mb-4">üìù</div><div>No investigators yet</div></td></tr>' : state.investigators.map(inv => {
                                            const hasBaptism = inv.monthlyData && inv.monthlyData.some(month => month && month.includes('BC'));
                                            return `
                                                <tr class="border-b hover:bg-indigo-50">
                                                    <td class="p-3"><input value="${inv.name || ''}" onchange="updateField('investigator', ${inv.id}, 'name', this.value)" placeholder="Name" class="w-full px-3 py-2 border rounded-lg text-sm"></td>
                                                    <td class="p-3"><input value="${inv.assignedTo || ''}" onchange="updateField('investigator', ${inv.id}, 'assignedTo', this.value)" placeholder="Assigned" class="w-full px-3 py-2 border rounded-lg text-sm"></td>
                                                    ${inv.monthlyData.map((activities, monthIndex) => `<td class="p-2 text-center month-cell" onclick="showActivityModal('investigator', ${inv.id}, ${monthIndex})">${activities && activities.length > 0 ? activities.map(code => `<span class="activity-badge bg-gradient-to-r from-indigo-500 to-purple-500 text-white">${code}</span>`).join('') : '<span class="text-gray-300 text-2xl">+</span>'}</td>`).join('')}
                                                    <td class="p-3"><input value="${inv.notes || ''}" onchange="updateField('investigator', ${inv.id}, 'notes', this.value)" placeholder="Notes" class="w-full px-3 py-2 border rounded-lg text-xs"></td>
                                                    <td class="p-3 no-print"><button onclick="deleteItem('investigator', ${inv.id})" class="text-red-500 hover:text-red-700 p-2">√ó</button></td>
                                                </tr>
                                                ${hasBaptism ? `<tr class="bg-green-50"><td colspan="15" class="p-6"><div class="flex items-center gap-3 mb-4"><div class="text-2xl">üìñ</div><div class="font-bold text-green-900">Covenant Path for ${inv.name}</div></div><div class="grid grid-cols-2 md:grid-cols-6 gap-3">${[{key:'confirmation',label:'Confirmation',icon:'‚úã'},{key:'holyGhost',label:'Holy Ghost',icon:'üïäÔ∏è'},{key:'sacrament',label:'Sacrament',icon:'üçû'},{key:'priesthood',label:'Priesthood',icon:'üëî'},{key:'temple',label:'Temple',icon:'üèõÔ∏è'},{key:'calling',label:'Calling',icon:'üìû'}].map(item => `<label class="flex items-center gap-3 cursor-pointer bg-white/60 rounded-xl p-3 hover:bg-white"><input type="checkbox" ${inv.covenantPath && inv.covenantPath[item.key] ? 'checked' : ''} onchange="updateField('investigator', ${inv.id}, 'covenant_${item.key}', this.checked)" class="w-5 h-5 text-green-600 rounded"><div><div class="text-xl">${item.icon}</div><div class="text-xs font-medium">${item.label}</div></div></label>`).join('')}</div></td></tr>` : ''}
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="glass-card rounded-2xl shadow-xl p-6">
                            <div class="flex justify-between items-center mb-6">
                                <div class="flex items-center gap-3"><div class="text-3xl">üíô</div><h2 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-cyan-600 bg-clip-text text-transparent">Less Active Families</h2></div>
                                <button onclick="addLessActive()" class="bg-gradient-to-r from-blue-600 to-cyan-600 text-white px-5 py-2.5 rounded-xl text-sm font-semibold transition-all hover:scale-105 shadow-lg no-print">+ Add Family</button>
                            </div>
                            <div class="overflow-x-auto rounded-xl">
                                <table class="w-full text-xs">
                                    <thead><tr><th class="p-3 text-left">Name</th><th class="p-3 text-left">Assigned</th>${MONTHS.map(m => `<th class="p-2">${m}</th>`).join('')}<th class="p-3">Notes</th><th class="p-3 no-print"></th></tr></thead>
                                    <tbody class="bg-white">
                                        ${state.lessActive.length === 0 ? '<tr><td colspan="15" class="text-center py-12 text-gray-400"><div class="text-6xl mb-4">üíô</div><div>No families yet</div></td></tr>' : state.lessActive.map(person => `
                                            <tr class="border-b hover:bg-blue-50">
                                                <td class="p-3"><input value="${person.name || ''}" onchange="updateField('lessActive', ${person.id}, 'name', this.value)" placeholder="Name" class="w-full px-3 py-2 border rounded-lg text-sm"></td>
                                                <td class="p-3"><input value="${person.assignedTo || ''}" onchange="updateField('lessActive', ${person.id}, 'assignedTo', this.value)" placeholder="Assigned" class="w-full px-3 py-2 border rounded-lg text-sm"></td>
                                                ${person.monthlyData.map((activities, monthIndex) => `<td class="p-2 text-center month-cell" onclick="showActivityModal('lessActive', ${person.id}, ${monthIndex})">${activities && activities.length > 0 ? activities.map(code => `<span class="activity-badge bg-gradient-to-r from-blue-500 to-cyan-500 text-white">${code}</span>`).join('') : '<span class="text-gray-300 text-2xl">+</span>'}</td>`).join('')}
                                                <td class="p-3"><input value="${person.notes || ''}" onchange="updateField('lessActive', ${person.id}, 'notes', this.value)" placeholder="Notes" class="w-full px-3 py-2 border rounded-lg text-xs"></td>
                                                <td class="p-3 no-print"><button onclick="deleteItem('lessActive', ${person.id})" class="text-red-500 hover:text-red-700 p-2">√ó</button></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="glass-card rounded-2xl shadow-xl p-6 no-print">
                            <div class="flex items-center gap-3 mb-4"><div class="text-3xl">üí°</div><h3 class="font-bold text-indigo-900 text-xl">How to Use This Tracker</h3></div>
                            <div class="grid md:grid-cols-2 gap-4 mb-6">
                                ${[
                                    {icon:'üìù',text:'Enter names of investigators or less-active members'},
                                    {icon:'üìÖ',text:'Click month cells to mark activities and invitations'},
                                    {icon:'‚úÖ',text:'Mark BC (Baptism Completed) to unlock Covenant Path tracking'},
                                    {icon:'üóìÔ∏è',text:'Add upcoming ward events everyone can see and reference'},
                                    {icon:'üìä',text:'Switch KPI views to analyze different time periods'},
                                    {icon:'üíæ',text:'Changes auto-save - everyone sees live updates!'}
                                ].map(item => `<div class="flex items-start gap-3 bg-gradient-to-r from-indigo-50 to-purple-50 p-4 rounded-xl"><div class="text-2xl">${item.icon}</div><p class="text-sm text-gray-700 pt-1">${item.text}</p></div>`).join('')}
                            </div>
                            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6 rounded-2xl">
                                <div class="flex items-start gap-3 mb-2"><div class="text-2xl">üìñ</div><p class="font-bold text-lg">Remember:</p></div>
                                <p class="text-sm italic leading-relaxed pl-11">"For behold the field is white already to harvest; and lo, he that thrusteth in his sickle with his might, the same layeth up in store that he perisheth not, but bringeth salvation to his soul"</p>
                                <p class="text-xs mt-2 pl-11 text-indigo-200">‚Äî Doctrine & Covenants 4:4</p>
                            </div>
                        </div>
                    </div>
                `;

                renderCharts(kpis);
            }

            console.log('‚úÖ App ready with Events Calendar');
        });
    </script>
</body>
</html>
