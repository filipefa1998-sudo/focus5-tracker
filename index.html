<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus 5 Missionary Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        @media print { .no-print { display: none !important; } }
        .month-cell { min-width: 45px; cursor: pointer; transition: all 0.15s ease; }
        .month-cell:hover { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        .month-cell:hover .activity-badge { color: white; background: rgba(255, 255, 255, 0.2); }
        .activity-badge { display: inline-block; padding: 2px 6px; margin: 1px; border-radius: 6px; font-size: 9px; font-weight: 600; letter-spacing: 0.3px; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08); }
        .gradient-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-card { transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12); }
        .pulse-dot { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .auto-save-indicator { position: fixed; bottom: 20px; right: 20px; z-index: 1000; transition: all 0.3s ease; }
        input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        table { border-collapse: separate; border-spacing: 0; }
        table thead th { position: sticky; top: 0; z-index: 10; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .chart-container { position: relative; height: 300px; }
        .kpi-icon { font-size: 2.5rem; filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1)); }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 min-h-screen p-2 md:p-6">
    <div id="root">
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-center glass-card p-8 rounded-2xl">
                <div class="text-6xl mb-4">ğŸ“¡</div>
                <p class="text-xl font-bold text-gray-800 mb-2">Loading...</p>
            </div>
        </div>
    </div>
    <div id="autoSaveIndicator" class="auto-save-indicator no-print"></div>

    <script type="module">
        // Import Firebase v10
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, onValue, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyAMTk39-yO86IA36-ZzBCtpLswW4skCIH4",
            authDomain: "focus5-cd663.firebaseapp.com",
            databaseURL: "https://focus5-cd663-default-rtdb.firebaseio.com",
            projectId: "focus5-cd663",
            storageBucket: "focus5-cd663.firebasestorage.app",
            messagingSenderId: "408021579800",
            appId: "1:408021579800:web:e064f6e4c13b7ac2d9eb6d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dataRef = ref(db, 'trackerData');

        console.log("âœ… Firebase loaded");

        // State
        const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        const INVITATION_TYPES = {'RB':'Read Book of Mormon','AC':'Attend Church','AA':'Attend Activity','FHE':'Attend FHE','TM':'Taught by Missionaries','PB':'Pray about BOM','BD':'Baptismal Date Set','BC':'Baptism Completed'};
        const FELLOWSHIP_TYPES = {'SRV':'Service','AI':'Activity Invited','AAT':'Activity Attended','VIS':'Visit','IFH':'Invited to do Family History','TXT':'Text/Call'};

        let state = { investigators: [], lessActive: [], kpiView: 'thisMonth', customDateRange: {start:'',end:''}, lastSaved: null, isLoaded: false };
        let saveTimeout = null;
        let isFirstLoad = true;

        // Save
        function triggerAutoSave() {
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => saveToFirebase(), 500);
        }

        function showSaveIndicator(status) {
            const indicator = document.getElementById('autoSaveIndicator');
            if (!indicator) return;
            if (status === 'saving') {
                indicator.innerHTML = '<div class="glass-card px-4 py-2 rounded-full flex items-center gap-2 shadow-lg"><div class="pulse-dot w-2 h-2 bg-yellow-500 rounded-full"></div><span class="text-sm font-medium text-gray-700">Syncing...</span></div>';
            } else if (status === 'saved') {
                indicator.innerHTML = '<div class="glass-card px-4 py-2 rounded-full flex items-center gap-2 shadow-lg"><div class="w-2 h-2 bg-green-500 rounded-full"></div><span class="text-sm font-medium text-gray-700">Synced âœ“</span></div>';
                setTimeout(() => { indicator.style.opacity = '0'; setTimeout(() => { indicator.innerHTML = ''; indicator.style.opacity = '1'; }, 300); }, 2000);
            }
        }

        function saveToFirebase() {
            showSaveIndicator('saving');
            const data = { investigators: state.investigators, lessActive: state.lessActive, kpiView: state.kpiView, customDateRange: state.customDateRange, lastSaved: Date.now() };
            set(dataRef, data).then(() => { console.log("âœ… Synced"); showSaveIndicator('saved'); }).catch(err => { console.error("âŒ Sync error:", err); showSaveIndicator('saved'); });
        }

        function loadFromFirebase() {
            onValue(dataRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    state.investigators = data.investigators || [];
                    state.lessActive = data.lessActive || [];
                    state.kpiView = data.kpiView || 'thisMonth';
                    state.customDateRange = data.customDateRange || {start:'',end:''};
                    state.lastSaved = data.lastSaved;
                }
                if (isFirstLoad) { state.isLoaded = true; isFirstLoad = false; console.log("âœ… Loaded"); }
                render();
            });
        }

        function updateSaveStatus() {
            const statusEl = document.getElementById('saveStatus');
            if (statusEl && state.lastSaved) {
                const date = new Date(state.lastSaved);
                statusEl.innerHTML = `<span class="text-xs text-white/80">${date.toLocaleTimeString()}</span>`;
            }
        }

        // Data functions
        window.addInvestigator = function() {
            const newInv = { id: Date.now(), name: '', assignedTo: '', monthlyData: Array(12).fill(null).map(() => []), notes: '', covenantPath: {confirmation:false,holyGhost:false,sacrament:false,priesthood:false,temple:false,calling:false} };
            state.investigators.push(newInv);
            triggerAutoSave();
            render();
        };

        window.addLessActive = function() {
            const newPerson = { id: Date.now(), name: '', assignedTo: '', monthlyData: Array(12).fill(null).map(() => []), notes: '' };
            state.lessActive.push(newPerson);
            triggerAutoSave();
            render();
        };

        window.updateField = function(type, id, field, value) {
            const list = type === 'investigator' ? state.investigators : state.lessActive;
            const item = list.find(i => i.id === id);
            if (item) {
                if (field.startsWith('covenant_')) {
                    const covenantField = field.replace('covenant_', '');
                    item.covenantPath[covenantField] = value;
                } else {
                    item[field] = value;
                }
                triggerAutoSave();
                render();
            }
        };

        window.toggleActivity = function(type, id, monthIndex, activityCode) {
            const list = type === 'investigator' ? state.investigators : state.lessActive;
            const item = list.find(i => i.id === id);
            if (item) {
                const monthData = item.monthlyData[monthIndex];
                const index = monthData.indexOf(activityCode);
                if (index > -1) { monthData.splice(index, 1); } else { monthData.push(activityCode); }
                triggerAutoSave();
                render();
            }
        };

        window.deleteItem = function(type, id) {
            if (!confirm('Delete this entry?')) return;
            if (type === 'investigator') { state.investigators = state.investigators.filter(i => i.id !== id); } else { state.lessActive = state.lessActive.filter(i => i.id !== id); }
            triggerAutoSave();
            render();
        };

        window.changeKPIView = function(view) {
            state.kpiView = view;
            triggerAutoSave();
            render();
        };

        window.exportData = function() {
            const data = { investigators: state.investigators, lessActive: state.lessActive, exportDate: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `focus5-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        };

        window.printTracker = function() { window.print(); };

        // KPI
        function getActiveMonths() {
            const now = new Date();
            const currentMonth = now.getMonth();
            switch(state.kpiView) {
                case 'thisMonth': return [currentMonth];
                case 'last3Months': return [(currentMonth-2+12)%12,(currentMonth-1+12)%12,currentMonth];
                case 'yearToDate': return Array.from({length: currentMonth + 1}, (_, i) => i);
                default: return [currentMonth];
            }
        }

        function calculateKPIs() {
            const activeMonths = getActiveMonths();
            const invitationCounts = {};
            let totalInvitations = 0, baptismsCompleted = 0;
            state.investigators.forEach(inv => { activeMonths.forEach(month => { inv.monthlyData[month].forEach(code => { invitationCounts[code] = (invitationCounts[code] || 0) + 1; totalInvitations++; if (code === 'BC') baptismsCompleted++; }); }); });
            const fellowshipCounts = {};
            let totalFellowship = 0, peopleEngaged = 0;
            state.lessActive.forEach(person => { let hasActivity = false; activeMonths.forEach(month => { person.monthlyData[month].forEach(code => { fellowshipCounts[code] = (fellowshipCounts[code] || 0) + 1; totalFellowship++; hasActivity = true; }); }); if (hasActivity) peopleEngaged++; });
            const mostActiveInvitation = Object.keys(invitationCounts).reduce((a, b) => invitationCounts[a] > invitationCounts[b] ? a : b, 'None');
            const mostCommonFellowship = Object.keys(fellowshipCounts).reduce((a, b) => fellowshipCounts[a] > fellowshipCounts[b] ? a : b, 'None');
            const activeFocus5 = state.investigators.filter(inv => activeMonths.some(month => inv.monthlyData[month].length > 0)).length + state.lessActive.filter(person => activeMonths.some(month => person.monthlyData[month].length > 0)).length;
            const totalActivities = totalInvitations + totalFellowship;
            const totalPeople = state.investigators.length + state.lessActive.length;
            const engagementRate = totalPeople > 0 ? Math.round(((state.investigators.filter(inv => activeMonths.some(month => inv.monthlyData[month].length > 0)).length + peopleEngaged) / totalPeople) * 100) : 0;
            return { totalPeople, activeFocus5, totalActivities, engagementRate, investigators: { totalInvitations, baptismsCompleted, mostActiveInvitation, avgPerPerson: state.investigators.length > 0 ? (totalInvitations / state.investigators.length).toFixed(1) : 0, breakdown: invitationCounts }, lessActive: { totalFellowship, peopleEngaged, mostCommonFellowship, avgPerFamily: state.lessActive.length > 0 ? (totalFellowship / state.lessActive.length).toFixed(1) : 0, breakdown: fellowshipCounts } };
        }

        // Render
        function render() {
            if (!state.isLoaded) return;
            const kpis = calculateKPIs();
            document.getElementById('root').innerHTML = `
                <div class="max-w-[1600px] mx-auto space-y-6">
                    ${renderHeader()}
                    ${renderKPIView()}
                    ${renderKPIDashboard(kpis)}
                    ${renderChartsSection(kpis)}
                    ${renderLegends()}
                    ${renderInvestigatorsSection()}
                    ${renderLessActiveSection()}
                    ${renderInstructions()}
                </div>
            `;
            updateSaveStatus();
            renderCharts(kpis);
        }

        function renderHeader() { return `<div class="glass-card rounded-2xl shadow-2xl p-6 md:p-8 gradient-header text-white"><div class="text-center"><div class="text-6xl mb-2">ğŸ“‹</div><h1 class="text-3xl md:text-5xl font-bold mb-3">Focus 5 Missionary Tracker</h1><p class="text-lg text-indigo-100 mb-4">Track your ward's missionary efforts</p><div class="max-w-3xl mx-auto bg-white/10 rounded-xl p-4 mb-4"><p class="text-sm italic">"And if it so be that you should labor all your days in crying repentance unto this people, and bring, save it be one soul unto me, how great shall be your joy with him in the kingdom of my Father!"</p><p class="text-xs mt-2 text-indigo-200">â€” D&C 18:15</p></div><div class="flex flex-wrap justify-center gap-3 no-print"><button onclick="exportData()" class="bg-white/20 hover:bg-white/30 text-white px-5 py-2.5 rounded-xl text-sm font-semibold">ğŸ“¥ Backup</button><button onclick="printTracker()" class="bg-white/20 hover:bg-white/30 text-white px-5 py-2.5 rounded-xl text-sm font-semibold">ğŸ–¨ï¸ Print</button></div><div class="mt-4 flex justify-center gap-3"><div class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-green-500/20 text-green-100 border border-green-300/30">ğŸ”„ Live Sync</div><div id="saveStatus"></div></div></div></div>`; }
        function renderKPIView() { return `<div class="glass-card rounded-2xl shadow-xl p-4"><div class="flex flex-wrap gap-3"><span class="font-semibold text-gray-700">ğŸ“Š View:</span><button onclick="changeKPIView('thisMonth')" class="${state.kpiView==='thisMonth'?'bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg':'bg-gray-100 text-gray-700'} px-4 py-2.5 rounded-xl text-sm font-semibold">ğŸ“… This Month</button><button onclick="changeKPIView('last3Months')" class="${state.kpiView==='last3Months'?'bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg':'bg-gray-100 text-gray-700'} px-4 py-2.5 rounded-xl text-sm font-semibold">ğŸ“Š Last 3 Months</button><button onclick="changeKPIView('yearToDate')" class="${state.kpiView==='yearToDate'?'bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg':'bg-gray-100 text-gray-700'} px-4 py-2.5 rounded-xl text-sm font-semibold">ğŸ“ˆ Year to Date</button></div></div>`; }
        function renderKPIDashboard(kpis) { const viewLabel={'thisMonth':'This Month','last3Months':'Last 3 Months','yearToDate':'Year to Date'}[state.kpiView]; return `<div class="glass-card rounded-2xl shadow-xl p-6"><h2 class="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-6">ğŸ“Š KPI Dashboard â€” ${viewLabel}</h2><div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">${renderKPICard('Total People',kpis.totalPeople,'ğŸ‘¥','from-blue-500 to-cyan-500')}${renderKPICard('Active Focus 5',kpis.activeFocus5,'â­','from-green-500 to-emerald-500')}${renderKPICard('Total Activities',kpis.totalActivities,'ğŸ“ˆ','from-purple-500 to-pink-500')}${renderKPICard('Engagement',kpis.engagementRate+'%','ğŸ¯','from-orange-500 to-red-500')}</div><div class="grid md:grid-cols-2 gap-6"><div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-2xl p-6"><div class="flex items-center gap-3 mb-4"><div class="text-4xl">ğŸ¯</div><h3 class="font-bold text-indigo-900">Current Investigators</h3></div><div class="grid grid-cols-2 gap-4 text-sm"><div class="bg-white/60 rounded-xl p-4 text-center"><div class="text-xs text-gray-600">Total Invitations</div><div class="text-3xl font-bold text-indigo-600">${kpis.investigators.totalInvitations}</div></div><div class="bg-white/60 rounded-xl p-4 text-center"><div class="text-xs text-gray-600">Baptisms</div><div class="text-3xl font-bold text-green-600">${kpis.investigators.baptismsCompleted}</div></div><div class="bg-white/60 rounded-xl p-4 text-center"><div class="text-xs text-gray-600">Most Active</div><div class="text-2xl font-bold text-purple-600">${kpis.investigators.mostActiveInvitation}</div></div><div class="bg-white/60 rounded-xl p-4 text-center"><div class="text-xs text-gray-600">Avg/Person</div><div class="text-2xl font-bold text-orange-600">${kpis.investigators.avgPerPerson}</div></div></div></div><div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-2xl p-6"><div class="flex items-center gap-3 mb-4"><div class="text-4xl">ğŸ’™</div><h3 class="font-bold text-blue-900">Less Active Members</h3></div><div class="grid grid-cols-2 gap-4 text-sm"><div class="bg-white/60 rounded-xl p-4 text-center"><div class="text-xs text-gray-600">Total Fellowship</div><div class="text-3xl font-bold text-blue-600">${kpis.lessActive.totalFellowship}</div></div><div class="bg-white/60 rounded-xl p-4 text-center"><div class="text-xs text-gray-600">People Engaged</div><div class="text-3xl font-bold text-cyan-600">${kpis.lessActive.peopleEngaged}</div></div><div class="bg-white/60 rounded-xl p-4 text-center"><div class="text-xs text-gray-600">Most Common</div><div class="text-2xl font-bold text-purple-600">${kpis.lessActive.mostCommonFellowship}</div></div><div class="bg-white/60 rounded-xl p-4 text-center"><div class="text-xs text-gray-600">Avg/Family</div><div class="text-2xl font-bold text-orange-600">${kpis.lessActive.avgPerFamily}</div></div></div></div></div></div>`; }
        function renderKPICard(label,value,icon,gradient) { return `<div class="stat-card bg-gradient-to-br ${gradient} rounded-2xl p-6 text-white shadow-lg"><div class="kpi-icon">${icon}</div><p class="text-sm opacity-90 mb-1">${label}</p><p class="text-4xl font-bold">${value}</p></div>`; }
        function renderChartsSection(kpis) { return `<div class="glass-card rounded-2xl shadow-xl p-6"><h2 class="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-6">ğŸ“Š Visual Analytics</h2><div class="grid md:grid-cols-3 gap-6"><div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-2xl p-6"><h3 class="font-bold text-indigo-900 mb-4 text-center">Invitation Types</h3><div class="chart-container"><canvas id="invitationPieChart"></canvas></div></div><div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-2xl p-6"><h3 class="font-bold text-blue-900 mb-4 text-center">Fellowship Activities</h3><div class="chart-container"><canvas id="fellowshipPieChart"></canvas></div></div><div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl p-6"><h3 class="font-bold text-green-900 mb-4 text-center">Progress Overview</h3><div class="chart-container"><canvas id="progressBarChart"></canvas></div></div></div></div>`; }
        function renderLegends() { return `<div class="grid md:grid-cols-2 gap-6"><div class="glass-card rounded-2xl p-6"><div class="flex items-center gap-3 mb-4"><div class="text-3xl">ğŸ¯</div><h3 class="font-bold text-indigo-900">Invitations Extended</h3></div><div class="grid grid-cols-2 gap-3 text-xs">${Object.entries(INVITATION_TYPES).map(([code,label])=>`<div class="flex items-center gap-2 bg-gradient-to-r from-indigo-50 to-purple-50 px-3 py-2 rounded-lg"><span class="font-bold text-indigo-700 bg-white px-2 py-1 rounded">${code}</span><span class="text-gray-700">${label}</span></div>`).join('')}</div></div><div class="glass-card rounded-2xl p-6"><div class="flex items-center gap-3 mb-4"><div class="text-3xl">ğŸ’™</div><h3 class="font-bold text-blue-900">Fellowship Activities</h3></div><div class="grid grid-cols-2 gap-3 text-xs">${Object.entries(FELLOWSHIP_TYPES).map(([code,label])=>`<div class="flex items-center gap-2 bg-gradient-to-r from-blue-50 to-cyan-50 px-3 py-2 rounded-lg"><span class="font-bold text-blue-700 bg-white px-2 py-1 rounded">${code}</span><span class="text-gray-700">${label}</span></div>`).join('')}</div></div></div>`; }
        function renderInvestigatorsSection() { return `<div class="glass-card rounded-2xl shadow-xl p-6"><div class="flex justify-between items-center mb-6"><div class="flex items-center gap-3"><div class="text-3xl">ğŸ¯</div><h2 class="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">Current Investigators</h2></div><button onclick="addInvestigator()" class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-5 py-2.5 rounded-xl text-sm font-semibold no-print">+ Add</button></div><div class="overflow-x-auto rounded-xl"><table class="w-full text-xs"><thead><tr><th class="p-3 text-left">Name</th><th class="p-3 text-left">Assigned</th>${MONTHS.map(m=>`<th class="p-2 text-center">${m}</th>`).join('')}<th class="p-3 text-left">Notes</th><th class="p-3 no-print"></th></tr></thead><tbody class="bg-white">${state.investigators.length===0?`<tr><td colspan="15" class="text-center py-12 text-gray-400"><div class="text-6xl mb-4">ğŸ“</div><div>No investigators yet</div></td></tr>`:state.investigators.map(inv=>renderInvestigatorRow(inv)).join('')}</tbody></table></div></div>`; }
        function renderInvestigatorRow(inv) { const hasBaptism=inv.monthlyData.some(month=>month.includes('BC')); return `<tr class="border-b hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50"><td class="p-3"><input type="text" value="${inv.name}" onchange="updateField('investigator',${inv.id},'name',this.value)" placeholder="Name" class="w-full px-3 py-2 border rounded-lg text-sm"></td><td class="p-3"><input type="text" value="${inv.assignedTo}" onchange="updateField('investigator',${inv.id},'assignedTo',this.value)" placeholder="Assigned" class="w-full px-3 py-2 border rounded-lg text-sm"></td>${inv.monthlyData.map((activities,monthIndex)=>`<td class="p-2 text-center month-cell" onclick="showActivityModal('investigator',${inv.id},${monthIndex})">${activities.length>0?activities.map(code=>`<span class="activity-badge bg-gradient-to-r from-indigo-500 to-purple-500 text-white">${code}</span>`).join(''):'<span class="text-gray-300 text-2xl">+</span>'}</td>`).join('')}<td class="p-3"><input type="text" value="${inv.notes}" onchange="updateField('investigator',${inv.id},'notes',this.value)" placeholder="Notes" class="w-full px-3 py-2 border rounded-lg text-xs"></td><td class="p-3 no-print"><button onclick="deleteItem('investigator',${inv.id})" class="text-red-500 hover:bg-red-50 rounded-lg p-2">Ã—</button></td></tr>${hasBaptism?renderCovenantPathRow(inv):''}`; }
        function renderCovenantPathRow(inv) { return `<tr class="bg-gradient-to-r from-green-50 to-emerald-50"><td colspan="15" class="p-6"><div class="flex items-center gap-3 mb-4"><div class="text-2xl">ğŸ“–</div><div class="font-bold text-green-900">Covenant Path for ${inv.name}</div></div><div class="grid grid-cols-2 md:grid-cols-6 gap-3">${[{key:'confirmation',label:'Confirmation',icon:'âœ‹'},{key:'holyGhost',label:'Holy Ghost',icon:'ğŸ•Šï¸'},{key:'sacrament',label:'Sacrament',icon:'ğŸ'},{key:'priesthood',label:'Priesthood',icon:'ğŸ‘”'},{key:'temple',label:'Temple',icon:'ğŸ›ï¸'},{key:'calling',label:'Calling',icon:'ğŸ“'}].map(item=>`<label class="flex items-center gap-3 cursor-pointer bg-white/60 rounded-xl p-3 hover:bg-white"><input type="checkbox" ${inv.covenantPath[item.key]?'checked':''} onchange="updateField('investigator',${inv.id},'covenant_${item.key}',this.checked)" class="w-5 h-5 text-green-600 rounded"><div><div class="text-xl">${item.icon}</div><div class="text-xs font-medium text-gray-700">${item.label}</div></div></label>`).join('')}</div></td></tr>`; }
        function renderLessActiveSection() { return `<div class="glass-card rounded-2xl shadow-xl p-6"><div class="flex justify-between items-center mb-6"><div class="flex items-center gap-3"><div class="text-3xl">ğŸ’™</div><h2 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-cyan-600 bg-clip-text text-transparent">Less Active Members</h2></div><button onclick="addLessActive()" class="bg-gradient-to-r from-blue-600 to-cyan-600 text-white px-5 py-2.5 rounded-xl text-sm font-semibold no-print">+ Add</button></div><div class="overflow-x-auto rounded-xl"><table class="w-full text-xs"><thead><tr><th class="p-3 text-left">Name</th><th class="p-3 text-left">Assigned</th>${MONTHS.map(m=>`<th class="p-2 text-center">${m}</th>`).join('')}<th class="p-3 text-left">Notes</th><th class="p-3 no-print"></th></tr></thead><tbody class="bg-white">${state.lessActive.length===0?`<tr><td colspan="15" class="text-center py-12 text-gray-400"><div class="text-6xl mb-4">ğŸ’™</div><div>No families yet</div></td></tr>`:state.lessActive.map(person=>renderLessActiveRow(person)).join('')}</tbody></table></div></div>`; }
        function renderLessActiveRow(person) { return `<tr class="border-b hover:bg-gradient-to-r hover:from-blue-50 hover:to-cyan-50"><td class="p-3"><input type="text" value="${person.name}" onchange="updateField('lessActive',${person.id},'name',this.value)" placeholder="Name" class="w-full px-3 py-2 border rounded-lg text-sm"></td><td class="p-3"><input type="text" value="${person.assignedTo}" onchange="updateField('lessActive',${person.id},'assignedTo',this.value)" placeholder="Assigned" class="w-full px-3 py-2 border rounded-lg text-sm"></td>${person.monthlyData.map((activities,monthIndex)=>`<td class="p-2 text-center month-cell" onclick="showActivityModal('lessActive',${person.id},${monthIndex})">${activities.length>0?activities.map(code=>`<span class="activity-badge bg-gradient-to-r from-blue-500 to-cyan-500 text-white">${code}</span>`).join(''):'<span class="text-gray-300 text-2xl">+</span>'}</td>`).join('')}<td class="p-3"><input type="text" value="${person.notes}" onchange="updateField('lessActive',${person.id},'notes',this.value)" placeholder="Notes" class="w-full px-3 py-2 border rounded-lg text-xs"></td><td class="p-3 no-print"><button onclick="deleteItem('lessActive',${person.id})" class="text-red-500 hover:bg-red-50 rounded-lg p-2">Ã—</button></td></tr>`; }
        function renderInstructions() { return `<div class="glass-card rounded-2xl p-6 no-print"><div class="flex items-center gap-3 mb-4"><div class="text-3xl">ğŸ’¡</div><h3 class="font-bold text-indigo-900 text-xl">How to Use</h3></div><div class="grid md:grid-cols-2 gap-4 mb-6">${[{icon:'ğŸ“',text:'Add names - syncs across all devices'},{icon:'ğŸ“…',text:'Click month cells to mark activities'},{icon:'âœ…',text:'Mark BC to track Covenant Path'},{icon:'ğŸ“Š',text:'Switch KPI views for time analysis'},{icon:'ğŸ’¾',text:'Auto-saves - everyone sees live updates!'},{icon:'ğŸ“¤',text:'Backup weekly for safety'}].map(item=>`<div class="flex gap-3 bg-gradient-to-r from-indigo-50 to-purple-50 p-4 rounded-xl"><div class="text-2xl">${item.icon}</div><p class="text-sm text-gray-700 pt-1">${item.text}</p></div>`).join('')}</div><div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6 rounded-2xl"><div class="flex gap-3 mb-2"><div class="text-2xl">ğŸ“–</div><p class="font-bold">Remember:</p></div><p class="text-sm italic pl-11">"For behold the field is white already to harvest; and lo, he that thrusteth in his sickle with his might, the same layeth up in store that he perisheth not, but bringeth salvation to his soul"</p><p class="text-xs mt-2 pl-11 text-indigo-200">â€” D&C 4:4</p></div></div>`; }
        function renderCharts(kpis) { setTimeout(()=>{ const invCtx=document.getElementById('invitationPieChart'); if(invCtx&&Object.keys(kpis.investigators.breakdown).length>0){new Chart(invCtx,{type:'doughnut',data:{labels:Object.keys(kpis.investigators.breakdown),datasets:[{data:Object.values(kpis.investigators.breakdown),backgroundColor:['#6366f1','#8b5cf6','#ec4899','#f59e0b','#10b981','#3b82f6','#ef4444','#14b8a6'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{padding:15,font:{size:11}}}}}});} const felCtx=document.getElementById('fellowshipPieChart'); if(felCtx&&Object.keys(kpis.lessActive.breakdown).length>0){new Chart(felCtx,{type:'doughnut',data:{labels:Object.keys(kpis.lessActive.breakdown),datasets:[{data:Object.values(kpis.lessActive.breakdown),backgroundColor:['#3b82f6','#06b6d4','#10b981','#f59e0b','#ec4899','#8b5cf6','#ef4444','#14b8a6'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{padding:15,font:{size:11}}}}}});} const progCtx=document.getElementById('progressBarChart'); if(progCtx){new Chart(progCtx,{type:'bar',data:{labels:['Investigators','Less Active','Total Activities'],datasets:[{label:'Count',data:[state.investigators.length,state.lessActive.length,kpis.totalActivities],backgroundColor:['rgba(99,102,241,0.8)','rgba(59,130,246,0.8)','rgba(16,185,129,0.8)'],borderRadius:8,borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,grid:{color:'rgba(0,0,0,0.05)'}},x:{grid:{display:false}}}}});} },100); }
        window.showActivityModal = function(type,id,monthIndex) { const list=type==='investigator'?state.investigators:state.lessActive; const item=list.find(i=>i.id===id); const activities=item.monthlyData[monthIndex]; const activityTypes=type==='investigator'?INVITATION_TYPES:FELLOWSHIP_TYPES; const modal=document.createElement('div'); modal.className='fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4'; modal.onclick=(e)=>{ if(e.target===modal)modal.remove(); }; modal.innerHTML=`<div class="glass-card rounded-2xl p-8 max-w-md w-full max-h-[80vh] overflow-y-auto shadow-2xl"><div class="flex items-center gap-3 mb-6"><div class="text-3xl">${type==='investigator'?'ğŸ¯':'ğŸ’™'}</div><div><h3 class="font-bold text-xl">${MONTHS[monthIndex]}</h3><p class="text-sm text-gray-600">${item.name||'New Entry'}</p></div></div><div class="space-y-2">${Object.entries(activityTypes).map(([code,label])=>`<label class="flex items-center gap-4 p-4 hover:bg-gradient-to-r ${type==='investigator'?'from-indigo-50 to-purple-50':'from-blue-50 to-cyan-50'} rounded-xl cursor-pointer"><input type="checkbox" ${activities.includes(code)?'checked':''} onchange="toggleActivity('${type}',${id},${monthIndex},'${code}');this.closest('.fixed').remove();" class="w-6 h-6 text-${type==='investigator'?'indigo':'blue'}-600 rounded-lg"><div class="flex-1"><span class="font-bold text-${type==='investigator'?'indigo':'blue'}-700 bg-white px-3 py-1 rounded-lg text-sm">${code}</span><span class="text-gray-700 ml-2">${label}</span></div></label>`).join('')}</div><button onclick="this.closest('.fixed').remove()" class="mt-6 w-full bg-gradient-to-r from-gray-600 to-gray-700 text-white px-6 py-3 rounded-xl font-semibold">Close</button></div>`; document.body.appendChild(modal); };

        // Start
        console.log("ğŸš€ Starting...");
        loadFromFirebase();
    </script>
</body>
</html>
